\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost2.612}[2014/10/27 v0.1 GOST 2.612-2011]

\RequirePackage{xecyr}
\RequirePackage{xparse}

\def\@objectId{}

\newcommand*{\@setObjectId}[1]{\edef\@objectId{#1}}

\newcommand*{\@objectMemberId}[1]{\@nameuse{@objectId}@#1}
\newcommand*{\@objectMemberItemId}[2]{\@nameuse{@objectId}@#1@\number#2}

\newcommand{\@defObject}[2]{%
	\@namedef{#1}##1{
		{
			\@setObjectId{\@objectMemberId{#1}}
			#2
			##1
		}
	}
}
\let\@object\@defObject

\newcommand{\@defObjectCollection}[2]{%
	\newcounter{\@objectMemberId{#1}}
	\@namedef{#1}##1{
		\stepcounter{\@objectMemberId{#1}}
		\@setObjectProperty{#1@count}{\number\value{@Формуляр@Изделие}}
		{
			\@setObjectId{\@objectMemberItemId{#1}{\value{\@objectMemberId{#1}}}}
			#2
			##1
		}
	}
}
\let\@objects\@defObjectCollection

\newcommand*{\@setObjectProperty}[2]{%
	% отключаю проверку переопределения из-за несовместимости со значениями по умолчанию
	%\@ifundefined{\@objectMemberId{#1}}{%
		\global\expandafter\edef\csname\@objectMemberId{#1}\endcsname{#2}%
	%}{%
	%	\errhelp{Команда должна быть пропущена, нажмите <return> для продолжения}%
	%	\errmessage{Переопределение значения элемента данных не допускается}%
	%}%
}

\newcommand*{\@defObjectProperty}[1]{%
	\@namedef{#1}##1{%
		\@setObjectProperty{#1}{##1}%
	}%
}

% TODO добавить проверку определения обязательных свойств
\let\@defObjectMandatoryProperty\@defObjectProperty
\let\@defObjectOptionalProperty\@defObjectProperty

\NewDocumentCommand{\@property}{s m o}{
	\IfBooleanTF{#1}{%
		\@defObjectOptionalProperty{#2}%
	}{%
		\@defObjectMandatoryProperty{#2}%
	}
	\IfNoValueF{#3}{%
		\@setObjectProperty{#2}{#3}%
	}
}

\@object{Формуляр}{
	% реквизиты формуляра
	\@objects{Организация}{ % в поле 1 титульного листа
		% данные об организации, эксплуатирующей эталон в настоящее время
		% и оформляющей формуляр
		\@property{Наименование}
		\@property*{ПочтовыйАдрес}
		\@property*{АдресСайта}
		\@property{ВидОрганизации}[эксплуатирующая организация]
		\@property*{Подразделение} % только для ЛУ, нет в ГОСТ 2.612
	}
	\@object{Разработал}{
		\@object{ДолжностноеЛицо}{
			\@property*{Должность}
			\@property{Фамилия}
			\@property*{Инициалы}
			%\@property{СертификатКлюча}
		}
		\@property*{Дата}
	}
	\@object{ЛУ}{
		% реквизиты листа утверждения, и титульного листа так же, если он использован в роли ЛУ
		\@objects{Разработал}{
			\@object{ДолжностноеЛицо}{
				\@property*{Должность}
				\@property{Фамилия}
				\@property*{Инициалы}
				%\@property{СертификатКлюча}
			}
			\@property*{Дата}
		}
		\@objects{Согласовал}{
			\@object{ДолжностноеЛицо}{
				\@property*{Должность}
				\@property{Фамилия}
				\@property*{Инициалы}
				%\@property{СертификатКлюча}
			}
			\@property*{Дата}
		}
		\@object{Утвердил}{
			\@object{ДолжностноеЛицо}{
				\@property*{Должность}
				\@property{Фамилия}
				\@property*{Инициалы}
				%\@property{СертификатКлюча}
			}
			\@property*{Дата}
		}
	}
	\@property*{Часть}
	
	% реквизиты изделия
	\@objects{Изделие}{
		\@property{Наименование}
		\@property{Обозначение}
		\@property*{УсловноеОбозначение}
		\@property{Номер}
		\@property*{КонтрольныйНомер}
	}
	\@property{ЕдиницаИзмерения}[шт.]
	\@objects{Характеристика}{
		\@property{Наименование}
		\@property{Значение}
		\@property*{УсловноеОбозначение}
		\@property{Номер}
		\@property*{КонтрольныйНомер}
	}
}
