\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{structs}[2014/11/06 v0.1 objects and properties]

\ProcessOptions\relax

\RequirePackage{xparse}

\def\@objectId{}

\newcommand*{\@setObjectId}[1]{\edef\@objectId{#1}}

\newcommand*{\@objectMemberId}[1]{\@nameuse{@objectId}@#1}
\newcommand*{\@objectMemberItemId}[2]{\@nameuse{@objectId}@#1@\number#2}

\newcommand{\@defObject}[2]{%
	\@namedef{#1}##1{
		{
			\@setObjectId{\@objectMemberId{#1}}
			%\NewDocumentCommand{\@objectMemberId{@get}}{t. m}{
				%\IfBooleanTF{####1}{%
				%	\@nameuse{\@objectMemberId{####2@@get}}%
				%}{%
				%	\PackageError{struct}{Expected . after \\obj\{objectId\}}%
				%}
			%}
			\expandafter\xdef\csname \@objectMemberId{@get}\endcsname####1{%
				\noexpand\csname \@objectMemberId{####1@@get}\endcsname%
			}
			#2
			##1
		}
	}
}
\let\@object\@defObject

\newcommand{\@defObjectCollection}[2]{%
	\newcounter{\@objectMemberId{#1}}
	\@namedef{#1}##1{
		\stepcounter{\@objectMemberId{#1}}
		\@setObjectProperty{#1@count}{\number\value{\@objectMemberId{#1}}}
		{
			\@setObjectId{\@objectMemberItemId{#1}{\value{\@objectMemberId{#1}}}}
			#2
			##1
		}
	}
}
\let\@objects\@defObjectCollection

\newcommand*{\@setObjectProperty}[2]{%
	% отключаю проверку переопределения из-за несовместимости со значениями по умолчанию
	%\@ifundefined{\@objectMemberId{#1}}{%
		\global\expandafter\edef\csname\@objectMemberId{#1}\endcsname{#2}%
	%}{%
	%	\errhelp{Команда должна быть пропущена, нажмите <return> для продолжения}%
	%	\errmessage{Переопределение значения элемента данных не допускается}%
	%}%
}

\newcommand*{\@defObjectProperty}[1]{%
	\@namedef{#1}##1{%
		\@setObjectProperty{#1}{##1}%
	}%
	\expandafter\xdef\csname \@objectMemberId{#1@@get}\endcsname{%
		\noexpand\@nameuse{\@objectMemberId{#1}}%
	}
}

% TODO добавить проверку определения обязательных свойств
\let\@defObjectMandatoryProperty\@defObjectProperty
\let\@defObjectOptionalProperty\@defObjectProperty

\NewDocumentCommand{\@property}{s m o}{
	\IfBooleanTF{#1}{%
		\@defObjectOptionalProperty{#2}%
	}{%
		\@defObjectMandatoryProperty{#2}%
	}
	\IfNoValueF{#3}{%
		\@setObjectProperty{#2}{#3}%
	}
}

\NewDocumentCommand{\obja}{m}{%
	\@nameuse{@#1@@get}%
	%\csname @#1@@get\endcsname%
} 

% #1 - object id
\NewDocumentCommand{\obj}{m t.}{%
	\IfBooleanTF{#2}{%
		\@doObjProperties{#1}%
	}{%
		\PackageError{struct}{Expected . after \\obj\{objectId\}}%
	}
} 

\NewDocumentCommand{\@doObjProperties}{m m t.}{%
	\@nameuse{@#1@#2}%
}

