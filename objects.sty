\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{structs}[2014/11/06 v0.1 objects and properties]

\ProcessOptions\relax

\RequirePackage{xparse}

\def\@object@this{}

\def\@setObjectId#1{\edef\@object@this{#1}}

\def\@objectMemberId#1{\@nameuse{@object@this}@#1}

\def\@objectMemberItemId#1[#2]{\@nameuse{@object@this}@#1@\number#2}

\def\@defObject#1#2{%
	\expandafter\def\csname#1\endcsname##1{
		{
			\@setObjectId{\@objectMemberId{#1}}
			#2
			##1
		}
	}
	\expandafter\xdef\csname \@objectMemberId{#1@@get}\endcsname.##1{%
		\noexpand\csname \@objectMemberId{#1@##1@@get}\endcsname%
	}
}
\let\@object\@defObject

\def\@defObjectCollection#1#2{%
	\newcounter{\@objectMemberId{#1}}
	\expandafter\def\csname#1\endcsname##1{
		\stepcounter{\@objectMemberId{#1}}
		\@setObjectProperty{#1@count}{\number\value{\@objectMemberId{#1}}}
		{
			\@setObjectId{\@objectMemberItemId{#1}[\value{\@objectMemberId{#1}}]}
			#2
			##1
		}
	}
	\expandafter\xdef\csname \@objectMemberId{#1@@get}\endcsname[##1].##2{%
		\noexpand\csname \@objectMemberId{#1@##1@##2@@get}\endcsname%
	}
}
\let\@objects\@defObjectCollection

\def\@setObjectProperty#1#2{%
	% отключаю проверку переопределения из-за несовместимости со значениями по умолчанию
	%\@ifundefined{\@objectMemberId{#1}}{%
		\expandafter\xdef\csname\@objectMemberId{#1}\endcsname{#2}%
	%}{%
	%	\errhelp{Команда должна быть пропущена, нажмите <return> для продолжения}%
	%	\errmessage{Переопределение значения элемента данных не допускается}%
	%}%
}

\def\@defObjectProperty#1{%
	\expandafter\def\csname#1\endcsname##1{%
		\@setObjectProperty{#1}{##1}%
	}%
	\expandafter\xdef\csname \@objectMemberId{#1@@get}\endcsname{%
		\noexpand\@nameuse{\@objectMemberId{#1}}%
	}
}

% TODO добавить проверку определения обязательных свойств
\let\@defObjectMandatoryProperty\@defObjectProperty
\let\@defObjectOptionalProperty\@defObjectProperty

\NewDocumentCommand{\@property}{s m o}{
	\IfBooleanTF{#1}{%
		\@defObjectOptionalProperty{#2}%
	}{%
		\@defObjectMandatoryProperty{#2}%
	}
	\IfNoValueF{#3}{%
		\@setObjectProperty{#2}{#3}%
	}
}

\def\object#1{%
	\csname @#1@@get\endcsname%
} 
