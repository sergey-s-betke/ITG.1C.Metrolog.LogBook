\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{structs}[2014/11/06 v0.1 objects and properties]

\ProcessOptions\relax

\RequirePackage{xparse}

\def\@object@this{}

\def\@object@this@set#1{\edef\@object@this{#1}}

\def\@object@this@MemberId#1{\@nameuse{@object@this}@#1}

\def\@object@this@MemberItemId#1[#2]{\@nameuse{@object@this}@#1@\number#2}

\def\@object@new#1#2{%
	\expandafter\def\csname#1\endcsname##1{
		{
			\@object@this@set{\@object@this@MemberId{#1}}
			#2
			##1
		}
	}
	\expandafter\xdef\csname \@object@this@MemberId{#1@@get}\endcsname.##1{%
		\noexpand\csname \@object@this@MemberId{#1@##1@@get}\endcsname%
	}
}
\let\@object\@object@new

\def\@object@newCollection#1#2{%
	\expandafter\newcount\csname\@object@this@MemberId{#1}@cnt\endcsname
	\@object@this@property@set{#1@@count}{0}
	\expandafter\def\csname#1\endcsname##1{
		\expandafter\advance\csname\@object@this@MemberId{#1}@cnt\endcsname by 1\relax
		\@object@this@property@set{#1@@count}{\expandafter\number\csname\@object@this@MemberId{#1}@cnt\endcsname}
		{
			\@object@this@set{\@object@this@MemberItemId{#1}[\expandafter\number\csname\@object@this@MemberId{#1}@cnt\endcsname]}
			#2
			##1
		}
	}
	\expandafter\xdef\csname \@object@this@MemberId{#1@@get}\endcsname[##1].##2{%
		\noexpand\csname \@object@this@MemberId{#1@##1@##2@@get}\endcsname%
	}
}
\let\@objects\@object@newCollection

\def\@object@this@property@set#1#2{%
	% отключаю проверку переопределения из-за несовместимости со значениями по умолчанию
	%\@ifundefined{\@object@this@MemberId{#1}}{%
		\expandafter\xdef\csname\@object@this@MemberId{#1}\endcsname{#2}%
	%}{%
	%	\errhelp{Команда должна быть пропущена, нажмите <return> для продолжения}%
	%	\errmessage{Переопределение значения элемента данных не допускается}%
	%}%
}

\def\@object@this@property@new#1{%
	\expandafter\def\csname#1\endcsname##1{%
		\@object@this@property@set{#1}{##1}%
	}%
	\expandafter\xdef\csname \@object@this@MemberId{#1@@get}\endcsname{%
		\noexpand\@nameuse{\@object@this@MemberId{#1}}%
	}
}

% TODO добавить проверку определения обязательных свойств
\let\@object@newMandatoryProperty\@object@this@property@new
\let\@object@newOptionalProperty\@object@this@property@new

\NewDocumentCommand{\@property}{s m o}{
	\IfBooleanTF{#1}{%
		\@object@newOptionalProperty{#2}%
	}{%
		\@object@newMandatoryProperty{#2}%
	}
	\IfNoValueF{#3}{%
		\@object@this@property@set{#2}{#3}%
	}
}

\def\object#1{%
	\csname @#1@@get\endcsname%
} 

\RequirePackage{forloop}

% #1 - collection
% #2 - current object
% #3 - loop code
\def\@object@forEach#1#2#3{%
	{%
		\edef\@counter{\string#2@cnt}%
		\newcounter{\@counter}%
		\forLoop{1}{2}{\@counter}{%
			\edef#2{\noexpand#1[\number\value{\@counter}]}%
			#3%
		}%
	}%
}

\let\forEachItem\@object@forEach
