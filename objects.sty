\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{structs}[2014/11/06 v0.1 objects and properties]

\ProcessOptions\relax

\RequirePackage{xparse}
\RequirePackage{forloop}

\def\@gobble@backslashchar#1{%
	\expandafter\@gobble@backslashchar@@\string#1%
}
\def\@gobble@backslashchar@@#1{%
	\expandafter\ifx\@backslashchar#1\else#1\fi%
}

\def\@object@this{}

\def\@object@this@set#1{\edef\@object@this{#1}}

\def\@object@member@id#1#2{#1@\@gobble@backslashchar#2}
\def\@object@this@member@id#1{\@object@member@id{\@object@this}{#1}}

\def\@object@item@id#1[#2]{#1@#2}
\def\@object@this@item@id[#1]{\@object@item@id{\@object@this}[#1]}

\def\@object@class@prototype#1{%
	\@object@this@set{#1}%
	\@object@this@method@new{@*}##1{%
		\noexpand\@object@method@call{\noexpand\@object@member@id{\@object@this}{##1}}{@*}%
	}%
	\@object@this@method@new{@let}##1{%
		\def##1{%
			\noexpand\@object@method@call{\@object@this}{@*}%
		}%
	}%
}

\def\@object@class@id#1{%
	@object@class@@\@gobble@backslashchar#1%
}

\def\@object@class@use#1{%
	\csname\@object@class@id#1\endcsname% ...
}

\def\@object@class@new#1#2#3{%
	% ##1 - instance name
	% ##2 - const definition code
	\expandafter\def\csname#2\endcsname##1##2{%
		{%
			\@object@class@prototype{\@object@this@member@id{##1}}%
			#3%
			##2%
		}%
	}%
}

% #1 - type name
% #2 - type definition
\def\@object@class@def#1{%
	\@object@class@new{#1}{\@object@class@id#1}%
}

\def\@object#1{%
	\@member{#1} of class {#1}%
	\@object@class@def{#1}% ...
}

% #1 - member name
% #2 - ignore spaces before `of class`
% #3 - class name
\def\@member#1#2of class#3{%
	\expandafter\def\csname\@gobble@backslashchar#1\endcsname{%
		\@object@class@use{#3}{#1}%
	}%
}

\def\object#1{%
	\@object@method@call{\@object@this@member@id{#1}}{@*}%
}

% #1 - type name
% #2 - instance name
% TODO implement different instance name
\def\@object@class@instance@new#1#2{%
	\expandafter\def\csname\@gobble@backslashchar#2\endcsname{%
		\@object@method@call{\@object@this@member@id{#2}}{@*}%
	}%
	\@object@class@use{#1}{#2}% ...
}

% #1 - const name
% #2 - ignore spaces before `of class`
% #3 - class name
\def\const#1#2of class#3{%
	\@object@class@instance@new{#3}{#1}%
}


\def\@object@collection@new#1#2{%
	\expandafter\newcount\csname\@object@member@id{\@object@this@member@id{#1}}{@cnt}\endcsname
	\@object@property@set{\@object@this@member@id{#1}}{@count}{0}
	\expandafter\def\csname#1\endcsname##1{
		\expandafter\advance\csname\@object@member@id{\@object@this@member@id{#1}}{@cnt}\endcsname by 1\relax
		{
			\@object@this@set{\@object@this@member@id{#1}}
			{
				\@object@this@property@set{@count}{\expandafter\number\csname\@object@this@member@id{@cnt}\endcsname}
				{
					\@object@class@prototype{\@object@this@item@id[\expandafter\number\csname\@object@this@member@id{@cnt}\endcsname]}%
					#2%
					##1%
				}
			}
		}
	}
	{
		\@object@this@set{\@object@this@member@id{#1}}
		\@object@this@method@new{@item@*}[##1]{%
			\noexpand\@object@method@call{\@object@this@item@id[##1]}{@*}%
		}%
		\@object@this@method@new{@member@*}##1{%
			\noexpand\@object@method@call{\@object@this}{@\noexpand\@gobble@backslashchar##1}%
		}%
		\@object@this@method@new{@foreach}##1##2{%
			\noexpand\newcounter{\@object@this@member@id{@cnt}}%
			\noexpand\forLoop%
				{1}%
				{\noexpand\@object@property@get{\@object@this}{@count}}%
				{\@object@this@member@id{@cnt}}%
				{%
					{%
						\noexpand\@object@method@call%
							{\noexpand\@object@item@id%
								{\@object@this}%
								[\noexpand\number\noexpand\value{\noexpand\@object@member@id{\@object@this}{@cnt}}]%
							}%
							{@let}%
							##1%
						##2%
					}%
				}%
		}%
		\@object@this@method@new{@*}{%
			\noexpand\@ifnextchar [{%
				\noexpand\@object@method@call{\@object@this}{@item@*}%
			}{%
				\noexpand\@object@method@call{\@object@this}{@member@*}%
			}%
		}%
	}
}
\let\@objects\@object@collection@new

\def\@object@property@set#1#2#3{%
	% отключаю проверку переопределения из-за несовместимости со значениями по умолчанию
	%\@ifundefined{\@object@this@member@id{#1}}{%
	\expandafter\xdef\csname\@object@member@id{#1}{#2}\endcsname{#3}%
	%}{%
	%	\errhelp{Команда должна быть пропущена, нажмите <return> для продолжения}%
	%	\errmessage{Переопределение значения элемента данных не допускается}%
	%}%
}
\def\@object@this@property@set#1#2{%
	\@object@property@set{\@object@this}{#1}{#2}%
}

\def\@object@property@get#1#2{%
	\csname\@object@member@id{#1}{#2}\endcsname%
}
\def\@object@this@property@get#1{%
	\@object@property@get{\@object@this}{#1}%
}

\def\@object@this@property@new#1{%
	\expandafter\def\csname#1\endcsname##1{%
		\@object@this@property@set{#1}{##1}%
	}%
	\@object@method@new{\@object@this@member@id{#1}}{@*}{%
		\@object@method@call{\@object@this@member@id{#1}}{@get}%
	}%
	\@object@method@new{\@object@this@member@id{#1}}{@get}{%
		\noexpand\@nameuse{\@object@this@member@id{#1}}%
	}%
}

\def\@object@method@new#1#2{%
	\expandafter\xdef\csname\@object@member@id{#1}{#2}\endcsname%
}
\def\@object@this@method@new#1{%
	\@object@method@new{\@object@this}{#1}%
}

\def\@object@method@call#1#2{%
	\csname\@object@member@id{#1}{#2}\endcsname%
}%
\def\@object@this@method@call#1{%
	\@object@method@call\@object@this#1%
}%

% TODO добавить проверку определения обязательных свойств
\let\@object@newMandatoryProperty\@object@this@property@new
\let\@object@newOptionalProperty\@object@this@property@new

\NewDocumentCommand{\@property}{s m o}{
	\IfBooleanTF{#1}{%
		\@object@newOptionalProperty{#2}%
	}{%
		\@object@newMandatoryProperty{#2}%
	}
	\IfNoValueF{#3}{%
		\@object@this@property@set{#2}{#3}%
	}
}
