\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost2.105.titlesheet}[2014/10/22 v0.1 GOST 2.105-95 Title sheet]

\RequirePackage{ifxetex}
\RequireXeTeX

\RequirePackage[T2A,T1]{fontenc}
\RequirePackage{gost6.38}

\RequirePackage{eskdstamp}
\RequirePackage{eskdtitle}

\RequirePackage{etex}
\RequirePackage{calc}

\renewenvironment{ESKDtitlePage}{%
	%\begin{ESKDpadding}{5mm}{5mm}
		\newpage%
	%	\ESKDsetPadding{5mm}{5mm}
	\ESKDstyle{\ESKD@default@style@title}%
	\parindent=0mm
	\topsep=0mm
	\begin{center}
}{%
	\end{center}
	%\end{ESKDpadding}
		\clearpage
	%	\ESKDsetPadding{\ESKD@padding@h}{\ESKD@padding@v}
	\aftergroup\ESKD@title@after@page
}

\renewcommand{\ESKDtitleMakeStamp}[2]{%
	\signatureStampBox{}{#1}{#2}{}
}

\renewcommand{\ESKD@title@split@field}[2]{%
	\par%
	\noindent%
	\parbox[t]{.5\linewidth}{\raggedright#1}%
	\hfill%
	\parbox[t]{.5\linewidth}{\raggedleft#2}%
	\par%
}

\renewcommand{\ESKDtheTitleFieldI}{%
	\begin{center}
		\ESKDtitleFontI
		\ESKDtheDepartment%
		\par%
		\ESKDtheCompany%
	\end{center}
}

\def\ESKDtheTitleFieldIIl{}

\renewcommand{\ESKDtheTitleFieldIIl}{%
	\noindent%
	\ESKDtitleFontII %
	\ESKDtheClassCode%
}

\renewcommand{\ESKDtheTitleFieldIIr}{}

\renewcommand{\ESKDtheTitleFieldII}{%
	\ESKDtitleFontII%
	\ESKD@title@split@field{\ESKDtheTitleFieldIIl}{\ESKDtheTitleFieldIIr}%
}

\renewcommand{\ESKDtheTitleFieldIIIl}{%
	\ifx\ESKD@title@approving@sheet\@undefined
		\expandafter%
		\ifx\csname ESKD@title@agreed@name@1\endcsname\relax\else
			\textbf{\MakeUppercase{\ESKDagreedName}}\\
			\ESKD@title@make@stamp{agreed}{1}
		\fi
	\else
		\textbf{\MakeUppercase{\ESKDapprovedName}}\\
		\ESKD@title@approving@sheet
	\fi
}
\renewcommand{\ESKDtheTitleFieldIIIl}{%
	\ifx\ESKD@title@approving@sheet\@undefined
		\expandafter%
		\ifx\csname ESKD@title@agreed@name@1\endcsname\relax\else
			\signatureStampBox %
				{\ESKDagreedName}%
				{\@nameuse{ESKD@title@agreed@post@1}}%
				{\@nameuse{ESKD@title@agreed@name@1}}%
				{}
		\fi
	\else
		\textbf{\MakeUppercase{\ESKDapprovedName}}\\
		\ESKD@title@approving@sheet
	\fi
}

\renewcommand{\ESKDtheTitleFieldIIIr}{%
	\ifx\ESKD@title@approving@sheet\@undefined
		\expandafter%
		\ifx\csname ESKD@title@approved@name@1\endcsname\relax\else
			\textbf{\MakeUppercase{\ESKDapprovingName}}\\
			\ESKD@title@make@stamp{approved}{1}
		\fi
	\fi
}
\renewcommand{\ESKDtheTitleFieldIIIr}{%
	\ifx\ESKD@title@approving@sheet\@undefined
		\expandafter%
		\ifx\csname ESKD@title@approved@name@1\endcsname\relax\else
			\signatureStampBox %
				{\ESKDapprovingName}%
				{\@nameuse{ESKD@title@approved@post@1}}%
				{\@nameuse{ESKD@title@approved@name@1}}%
				{}%
		\fi
	\fi
}

\renewcommand{\ESKDtheTitleFieldIII}{%
	\ESKDtitleFontIII%
	\ESKD@title@split@field{\ESKDtheTitleFieldIIIl}{\ESKDtheTitleFieldIIIr}%
}

\renewcommand{\ESKDtheTitleFieldIV}{%
	\begin{center}%
		\ESKDtitleFontIV%
		\MakeUppercase{\ESKDtheTitle}%
		\par
		\ESKDtheDocName%
		\par
	\end{center}
}

\renewcommand{\ESKDtheTitleFieldV}{}

\renewcommand{\ESKDtheTitleFieldVI}{%
	\MakeUppercase{\ESKDtheSignature}%
}

\renewcommand{\ESKDtheTitleFieldVII}{}

\def\ESKDtheTitleFieldVIIIl{}

\renewcommand{\ESKDtheTitleFieldVIIIl}{%
	\ifx\ESKD@title@approving@sheet\@undefined
		\ESKD@tmpcnta = 1
		\loop
			\ifnum \ESKD@tmpcnta < \ESKD@title@agreed@cnt
			\advance \ESKD@tmpcnta 1
			\signatureStampBox %
				{}%
				{\@nameuse{ESKD@title@agreed@post@\number\ESKD@tmpcnta}}%
				{\@nameuse{ESKD@title@agreed@name@\number\ESKD@tmpcnta}}%
				{}%
			%\par\vspace{5mm}
		\repeat
	\fi
}

\def\ESKDtheTitleFieldVIIIr{}

\renewcommand{\ESKDtheTitleFieldVIIIr}{%
	\ifx\ESKD@title@approving@sheet\@undefined
		\ESKD@tmpcnta = 0
		\loop
			\ifnum \ESKD@tmpcnta < \ESKD@title@designed@cnt
			\advance \ESKD@tmpcnta 1
			\signatureStampBox %
				{}%
				{\@nameuse{ESKD@title@designed@post@\number\ESKD@tmpcnta}}%
				{\@nameuse{ESKD@title@designed@name@\number\ESKD@tmpcnta}}%
				{}%
			%\par\vspace{5mm}
		\repeat
	\fi
}

\renewcommand{\ESKDtheTitleFieldVIII}{%
	\ESKDtitleFontVIII%
	\ESKD@title@split@field{\ESKDtheTitleFieldVIIIl}{\ESKDtheTitleFieldVIIIr}%
}

\renewcommand{\ESKDtheTitleFieldX}{\ESKDtheYear}

\renewcommand{\ESKDtitleFontI}{\ESKDfontV\bfseries}
\renewcommand{\ESKDtitleFontII}{\ESKDfontIII}
\renewcommand{\ESKDtitleFontIII}{%
	\ESKDfontIII\renewcommand{\baselinestretch}{1.50}\selectfont}
\renewcommand{\ESKDtitleFontIV}{\ESKDfontV\bfseries}
\renewcommand{\ESKDtitleFontV}{\ESKDfontV}
\renewcommand{\ESKDtitleFontVI}{\ESKDfontV}
\renewcommand{\ESKDtitleFontVII}{\ESKDfontIII}
\renewcommand{\ESKDtitleFontVIII}{%
	\ESKDfontIII\renewcommand{\baselinestretch}{1.25}\selectfont}
\renewcommand{\ESKDtitleFontX}{\ESKDfontV}

\newsavebox{\ESKD@theTitleField@IV@box}

\renewcommand{\maketitle}{%
	\begin{ESKDtitlePage}
		% отрисовываем поле 4 (заголовок) в бокс с целью центрирования по вертикали на странице
		\locbox\ESKD@theTitleField@IV@box
		\sbox\ESKD@theTitleField@IV@box{%
			\parbox{\linewidth}{%
				\ESKDtheTitleFieldIV%
			}%
		}
		\newlength{\@beforeTitle}
		\setlength{\@beforeTitle}{(\vsize-\totalheightof{\usebox\ESKD@theTitleField@IV@box}-\parskip-\baselineskip)/2}
		\hbox{%
			\vtop{
				\ESKDtheTitleFieldI%
				\vspace{5mm}
				\ESKDtheTitleFieldII%
				\vspace{10mm}
				\ESKDtheTitleFieldIII%
				\par\vspace{10mm \@minus 4mm}
			}%
			\vtop to \@beforeTitle{}%
		}\par
		\usebox{\ESKD@theTitleField@IV@box}\par
		\vfil
		\parbox[t][.4\vsize plus 150mm][b]{\linewidth}{
			\setlength{\topsep}{0mm}
			\begin{center}\ESKDtitleFontV\ESKDtheTitleFieldV\end{center}
			\begin{center}\ESKDtitleFontVI\ESKDtheTitleFieldVI\end{center}
			\begin{center}\ESKDtitleFontVII\ESKDtheTitleFieldVII\end{center}
			\par\vspace{10mm \@plus 30mm \@minus 2mm}
			\ESKDtheTitleFieldVIII%
			\vfill
			\begin{center}\ESKDtitleFontX\ESKDtheTitleFieldX\end{center}
		}
	\end{ESKDtitlePage}
}