\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{gost2.610.logbook}[2014/11/05 v0.1 GOST 2.610-2006 Logbook]

\DeclareOption*{%
	\PassOptionsToClass{\CurrentOption}{gost2.105}
}

\ExecuteOptions{pointsubsection}

\ProcessOptions\relax

\RequirePackage{xecyr}

\RequirePackage{xstring}

\RequirePackage{longtable}
% решаем проблемы несовместимости пакетов
\let\c@table\relax
\let\tablename\relax

\RequirePackage{tabu}

\def\addtokens#1#2{%
	#1\expandafter{\the#1#2}%
}
\def\eaddtokens#1#2{%
	\edef\reserved@a{\the#1#2}%
	#1\expandafter{\reserved@a}%
}

\newcommand{\@Формуляр@ФамилияИО}[1]{%
	\@ФамилияИО{\Формуляр{#1}\ДолжностноеЛицо}%
}

\def\@ФамилияИО#1{%
	#1\Фамилия~#1\Инициалы%
}

\def\Документ#1{%
	#1\Наименование%
	#1\ifexists\Обозначение%
		\space#1\Обозначение%
	\fi%
}


\AtBeginDocument{
	\ESKDcompany{\Формуляр\Организация\Наименование}
	\Формуляр\Организация\ifexists\Подразделение
		\ESKDdepartment{\Формуляр\Организация\Подразделение}
	\fi
	\Формуляр\ИдентификационныеДанные\Изделие\ifexists\КодОКП
		\ESKDclassCode{ОКП~\StrLeft{\Формуляр\ИдентификационныеДанные\Изделие\КодОКП}{2}~\StrGobbleLeft{\Формуляр\ИдентификационныеДанные\Изделие\КодОКП}{2}}
	\fi

	\ESKDtitle{\Формуляр\ИдентификационныеДанные\Изделие\Наименование}
	\ESKDdocName{Формуляр}
	\ESKDsignature{\Формуляр\ИдентификационныеДанные\Изделие\Обозначение}
	
	\ESKDtitleDesignedBy{Ведущий инженер по метрологии}{Богданова~Т.~М.}
	\ESKDtitleDesignedBy{Инженер по метрологии}{Дель~Н.~Н.}
	
	\ESKDtitleAgreedBy{\Формуляр\Согласовал[1]\ДолжностноеЛицо\Должность}{\@ФамилияИО{\Формуляр\Согласовал[1]\ДолжностноеЛицо}}
	\ESKDtitleAgreedBy{Инженер по стандартизации}{Наумова~Т.~И.}
	\ESKDtitleAgreedBy{Инженер по стандартизации}{Наумова~Т.~И.}
	
	\ESKDtitleApprovedBy{%
		\Формуляр\Утвердил\ДолжностноеЛицо\Должность%
	}{\@Формуляр@ФамилияИО{Утвердил}}

	\ESKDauthor{\@ФамилияИО{\Формуляр\Разработал[1]\ДолжностноеЛицо}}
	\ESKDchecker{\@Формуляр@ФамилияИО{Проверил}}
	\Формуляр\ifexists\МетрологическийКонтроль
		\renewcommand{\ESKDcolumnXfIVname}{М.~контр.}
		\ESKDcolumnXIfIV{\@Формуляр@ФамилияИО{МетрологическийКонтроль}}
	\fi
	\ESKDnormContr{\@Формуляр@ФамилияИО{Нормоконтроль}}
	\ESKDapprovedBy{\@Формуляр@ФамилияИО{Утвердил}}
	
	%\ESKDdate{2014/10/24}
}

\LoadClass{gost2.105}
\RequirePackage{gost2.612}
\RequirePackage{todo}

\providecommand{\УказанияПоЭксплуатацииИзделия}[1]{
	\@namedef{Формуляр@УказанияПоЭксплуатацииИзделия}{#1}
}

\УказанияПоЭксплуатацииИзделия{
	\paragraph{} Перед эксплуатацией изделия следует внимательно изучить
	эксплуатационную документацию на изделие%
	\Формуляр\Документация\ifexists\РЭ%
		, в частности~--- \Документ{\Формуляр\Документация\РЭ}%
		\done\todo{Необходима подстановка обозначения руководства и его наименования}%
		.
		\todo{Для оформления ссылок на сторонние документы необходимо определить свои
			макросы, которые обеспечат корректные пробелы и, возможно, другое оформление}
	\fi
}

\providecommand{\ПравилаЗаполненияИВеденияФормуляра}[1]{
	\@namedef{Формуляр@ПравилаЗаполненияИВеденияФормуляра}{#1}
}

\ПравилаЗаполненияИВеденияФормуляра{
	\paragraph{}\label{МОЛ} За ведение формуляра отвечает лицо, ответственное за эксплуатацию изделия.
	Ответственное за эксплуатацию изделия лицо указано в
	инвентарной карточке учёта объекта основных средств (форма №~ОС-6),
	хранящейся в регистрах бухгалтерского учёта.
	
	\paragraph{} Не допускаются записи в формуляре карандашом, смывающимися чернилами.
	Не допускаются подчистки.
	Неправильная запись должна быть аккуратно зачёркнута и рядом (в следующей строке) внесена новая запись.
	
	\paragraph{} Новые записи следует заверять подписью лица, ответственного за эксплуатацию изделия.
	После подписи следует указать фамилию и инициалы ответственного лица (вместо подписи допускается
	проставлять личный штамп).
	
	\paragraph{} При передаче изделия на другое предприятие итоговые записи по
	наработке следует заверять печатью предприятия, передающего изделие.
}

\AtBeginDocument{
	\maketitle
	\tableofcontents
	
	
	\ifx\Формуляр@УказанияПоЭксплуатацииИзделия\empty\else
		\ifx\Формуляр@ПравилаЗаполненияИВеденияФормуляра\empty\else
			
			\section{Общие указания}
			
			\ifx\Формуляр@УказанияПоЭксплуатацииИзделия\empty\else
				\subsection{Указания по эксплуатации изделия}
				\Формуляр@УказанияПоЭксплуатацииИзделия
			\fi
			
			\ifx\Формуляр@ПравилаЗаполненияИВеденияФормуляра\empty\else
				\subsection{Правила заполнения и ведения формуляра}
				\Формуляр@ПравилаЗаполненияИВеденияФормуляра
			\fi
			
		\fi
	\fi
	
	
	\section{Основные сведения об изделии}
	
	\paragraph{Наименование изделия}: \Формуляр\ИдентификационныеДанные\Изделие\Наименование.
	\done\todo{Заменить на свой макрос}
	
	\paragraph{Дата изготовления}: \Формуляр\ИдентификационныеДанные\ДатаИзготовления.
	\done\todo{Указать дату изготовления, форматировать макросом}
	\todo{Форматировать даты макросами}
	
	\paragraph{Производитель}:
	\def\Производитель{\Формуляр\ИдентификационныеДанные\Производитель}%
	\Производитель\ifexists\АдресСайта%
		\href{\Производитель\АдресСайта}{\Производитель\Наименование}%
	\else%
		\Производитель\Наименование%
	\fi.
	\done\todo{Указать производителя}
	\done\todo{Дать ссылку на сайт производителя, если он указан}
	
	\paragraph{Заводской номер}: \Формуляр\ИдентификационныеДанные\Изделие\Номер.
	\done\todo{Указать заводской номер}

	\Формуляр\ИдентификационныеДанные\ifexists\СредствоИзмерения
		\def\СИ{\Формуляр\ИдентификационныеДанные\СредствоИзмерения}

		\paragraph{Тип средства измерения}: \СИ\ТипСИ.
		\done\todo{Указать тип средства измерения, если он указан в реквизитах}
		
		\paragraph{Регистрационный номер в Государственном реестре средств измерений}:
		\href{http://www.fundmetrology.ru/10\_tipy\_si/7list.aspx?z=\&n=\СИ\НомерГРСИ}{\СИ\НомерГРСИ}.
		\done\todo{Указать номер в ГРСИ, если он указан}
		\done\todo{Дать гиперссылку на сайт ФИФ на номере ГРСИ, либо вообще - на всём параграфе}
		\todo{Для ссылок на ФИФ целесообразно определить свой макрос в отдельном стилевом файле}
		\todo{Ввести сокращения СИ, ГРСИ, расшифровах их в соответствующем разделе}
		
		\СИ\ifexists\СвидетельствоОРегистрацииТипаСИ
			\def\Свидетельство{\СИ\СвидетельствоОРегистрацииТипаСИ}
		
			\paragraph{Номер свидетельства о регистрации типа средства измерения}: \Свидетельство\Номер.
			\done\todo{Указать номер свидетельства, если он указан}
			
			\paragraph{Срок действия свидетельства о регистрации типа средства измерения}:
			\Свидетельство\ifexists\СрокДействия%
				\Свидетельство\СрокДействия%
			\else%
				не указан%
			\fi.
			\done\todo{Указать срок действия свидетельства, если он указан}
			\todo{Форматировать даты макросами}
	
		\fi

	\fi
		
	
	\section{Основные технические данные}
	
	\Формуляр\ОсновныеТехническиеДанные\ifexists\КаналИзмерений
		Метрологические характеристики приведены в таблице~\ref{МетрологическиеХарактеристики}.
		\todo{Заполнить раздел <<Основные технические сведения>> сведениями об измерительных каналах и
			нормируемых метрологических характеристиках}
		
		\newif\ifОтИДоВОднихЕИ
				
		\begin{longtabu}[c]
			{|X[b]|X[-1,c]|X[-1,r,b]|}
			\caption{Метрологические характеристики\label{МетрологическиеХарактеристики}} \\
			\hline%
			Наименование параметра          & Диапазон & Значение                      \\\hline\endfirsthead
			\caption*{Продолжение таблицы}                                             \\
			\hline%
			Наименование параметра          & Диапазон & Значение                      \\\hline\endhead
			\hline%
			\multicolumn{\the\LT@cols}{r}{Продолжение таблицы на следующей странице}   \\\endfoot
			%\hline
			                                                                             \endlastfoot
			\@temptokena{}
			\Формуляр\ОсновныеТехническиеДанные\КаналИзмерений\foreach{\КаналИзмерений}{
				\edef\ЕдиницаИзмерения{\КаналИзмерений\Диапазон\От\ЕдиницаИзмерения}
				\edef\reserved@b{\КаналИзмерений\Диапазон\До\ЕдиницаИзмерения}
				\ifx\ЕдиницаИзмерения\reserved@b \ОтИДоВОднихЕИtrue \else \ОтИДоВОднихЕИfalse \fi
				%
				\global\eaddtokens\@temptokena{\КаналИзмерений\Наименование \ifОтИДоВОднихЕИ, \ЕдиницаИзмерения\fi}
				\global\addtokens\@temptokena{&}
				\global\eaddtokens\@temptokena{От~}
				\global\addtokens\@temptokena{$\numprint}
					\global\eaddtokens\@temptokena{{\КаналИзмерений\Диапазон\От\Значение}}
					\global\addtokens\@temptokena{$}
				\ifОтИДоВОднихЕИ\else \global\eaddtokens\@temptokena{~\КаналИзмерений\Диапазон\От\ЕдиницаИзмерения} \fi					
				\global\eaddtokens\@temptokena{ до~}
				\global\addtokens\@temptokena{$\numprint}
					\global\eaddtokens\@temptokena{{\КаналИзмерений\Диапазон\До\Значение}}
					\global\addtokens\@temptokena{$}
				\ifОтИДоВОднихЕИ\else \global\eaddtokens\@temptokena{~\КаналИзмерений\Диапазон\До\ЕдиницаИзмерения} \fi					
				\global\eaddtokens\@temptokena{~включ.}
				\global\addtokens\@temptokena{&}
				%
				%\КаналИзмерений\testexists\НормируемаяМетрологическаяХарактеристика
				%\ifexists
					\КаналИзмерений\НормируемаяМетрологическаяХарактеристика\foreach{\Характеристика}{
						%\Характеристика\testexists\ВДиапазонеИзмерений
						%\ifexists
						%\fi
						\global\addtokens\@temptokena{\\\nopagebreak}
						\global\addtokens\@temptokena{\hspace{10mm}\parbox[b]{\linewidth-10mm}}
							\global\eaddtokens\@temptokena{{\Характеристика\Наименование, \Характеристика\Значение\ЕдиницаИзмерения}}
						\global\addtokens\@temptokena{&}
						\global\addtokens\@temptokena{&}
						\global\addtokens\@temptokena{$\numprint}
							\global\eaddtokens\@temptokena{{\Характеристика\Значение\Значение}}
							\global\addtokens\@temptokena{$}
					}
				%\fi
				%
				\global\addtokens\@temptokena{\\}
				\global\addtokens\@temptokena{\hline}
			}%
			\the\@temptokena
		\end{longtabu}
		\todo{При выводе единиц измерения диапазона при условии, что ЕИ начала и конца диапазона совпадает
			выводить её один раз, непосредственно за наименованием канала}
	\fi
		
	\Формуляр\ОсновныеТехническиеДанные\ifexists\Характеристика
		Основные технические данные приведены в таблице~\ref{Характеристики}.
		\done\todo{Заполнить раздел <<Основные технические сведения>> характеристиками}

		\begin{longtabu}[c]
			{|X[b]|X[-1,r,b]|}
			\caption{Основные технические данные\label{Характеристики}}             \\
			\hline%
			Наименование параметра          & Значение                              \\\hline\endfirsthead
			\caption*{Продолжение таблицы}                                          \\
			\hline%
			Наименование параметра          & Значение                              \\\hline\endhead
			\hline%
			\multicolumn{\the\LT@cols}{r}{Продолжение таблицы на следующей странице}\\\endfoot
			\hline
																					  \endlastfoot
			\@temptokena{}
			\Формуляр\ОсновныеТехническиеДанные\Характеристика\foreach{\Характеристика}{
				\global\eaddtokens\@temptokena{\Характеристика\Наименование, \Характеристика\Значение\ЕдиницаИзмерения}
				\global\addtokens\@temptokena{&}
				\global\addtokens\@temptokena{$\numprint}
					\global\eaddtokens\@temptokena{{\Характеристика\Значение\Значение}}
					\global\addtokens\@temptokena{$}
				\global\addtokens\@temptokena{\\} %\hline}
			}%
			\the\@temptokena
		\end{longtabu}
	\fi
	
	\Формуляр\Документация\ifexists\РЭ%
		Более подробно~--- смотрите \Документ{\Формуляр\Документация\РЭ}.
		\done\todo{Указать обозначение руководства по эксплуатации}
		\done\todo{Абзац вставлять только в том случае, если руководство по эксплуатации указано}
	\fi


	\section{Индивидуальные особенности изделия}

	\todo{Раздел <<Индивидуальные особенности изделия>> приводить только в том случае, если таковые
		указаны в данных}
	
	
	\section{Комплектность}
	
	\todo{Раздел <<Комплектность>>  приводить только в том случае, если данные о комплектности
		присутствуют в данных}
	
	
	\section{Ресурсы, сроки службы и хранения, гарантии изготовителя}
	
	\todo{Раздел <<Ресурсы, сроки службы и хранения, гарантии изготовителя>>
		приводить только в том случае, если данные присутствуют}
	
	
	\section{Консервация}
	
	\todo{Заполнить раздел <<Консервация>>}
	
	
	\section{Свидетельство об упаковывании}
	
	\todo{Раздел <<Свидетельство об упаковывании>>
		приводить только в том случае, если данные присутствуют}
	
	Данные об упаковывании изделия приведены в руководстве по эксплуатации.
	\todo{Абзац вставлять только в том случае, если руководство по эксплуатации указано}
	\todo{Указать обозначение руководства по эксплуатации}
	
	
	\section{Свидетельство о приёмке}
	
	\todo{Раздел <<Свидетельство о приёмке>>
		приводить только в том случае, если данные присутствуют}
	
	Данные о приёмке изделия приведены в руководстве по эксплуатации.
	\todo{Абзац вставлять только в том случае, если руководство по эксплуатации указано}
	\todo{Указать обозначение руководства по эксплуатации}
	
	
	\section{Движение изделия при эксплуатации}
	
	\todo{Заполнить раздел <<Движение изделия при эксплуатации>>}
	
	\subsection{Приём и передача изделия}
	
	\todo{Заполнить раздел <<Приём и передача изделия>>}
	
	\subsection{Сведения о закреплении изделия при эксплуатации}
	
	\todo{Заполнить раздел <<Сведения о закреплении изделия при эксплуатации>>}
	
	
	%\section{Учёт работы изделия}
	
	
	\section{Учёт технического обслуживания}
	
	\todo{Заполнить раздел <<Учёт технического обслуживания>>}
	
	
	%\section{Учёт работы по бюллетням и указаниям}
	
	
	\section{Работы при эксплуатации}
	
	\todo{Заполнить раздел <<Работы при эксплуатации>>}
	
	\subsection{Учёт выполнения работ}
	
	\todo{Заполнить раздел <<Учёт выполнения работ>>}
	
	\subsection{Особые замечания по эксплуатации и аварийным случаям}
	
	\todo{Заполнить раздел <<Особые замечания по эксплуатации и аварийным случаям>>}
	
	\subsection{Поверка средств измерений}
	
	\todo{Заполнить раздел <<Поверка средств измерений>>}
	
	\subsection{Техническое освидетельствование контрольными органами}
	
	\todo{Заполнить раздел <<Техническое освидетельствование контрольными органами>>,
		если он требуется для изделия}
	
	\subsection{Сведения о рекламациях}
	
	\todo{Заполнить раздел <<Сведения о рекламациях>>}
	
	
	\section{Хранение}
	
	\todo{Заполнить раздел <<Хранение>>}
	
	
	\section{Ремонт}
	
	\todo{Заполнить раздел <<Ремонт>>}
	
	\subsection{Краткие сведения о произведённом ремонте}
	
	\todo{Заполнить раздел <<Краткие сведения о произведённом ремонте>>}
	
	\subsection{Данные приёмосдаточных испытаний}
	
	\todo{Заполнить раздел <<Краткие сведения о произведённом ремонте>>}
	
	\subsection{Свидетельство о приёмке и гарантии}
	
	\todo{Заполнить раздел <<Свидетельство о приёмке и гарантии>>}
	
	
	\section{Особые отметки}
	
	\todo{Вставить чистые графы для раздела <<Особые отметки>> для ручного заполнения}
	\todo{В дальнейшем заполнять раздел <<Особые отметки>>}
	
	
	\section{Сведения об утилизации}
	
	Сведения об утилизации изделия приведены в руководстве по эксплуатации.
	\todo{Указать обозначение руководства по эксплуатации}
	
	
	\section{Контроль состояния изделия и ведения формуляра}
	
	\todo{Заполнить раздел <<Контроль состояния изделия и ведения формуляра>>}
	
	
	\section{Сведения о цене и условиях приобретения изделия}
	
	\todo{Заполнить раздел <<Сведения о цене и условиях приобретения изделия>>}
}

\AtEndDocument{
	\newpage
	\todo{Создать и заполнить раздел терминов и определений}
	\todo{Создать и заполнить раздел списка литературы}
	\newpage
	
	\todos{}
}
