\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{gost2.610.logbook}[2014/11/05 v0.1 ГОСТ 2.610-2006 ЕСКД. Правила выполнения эксплуатационных документов. Формуляр]

\DeclareOption*{%
	\PassOptionsToClass{\CurrentOption}{gost2.105}
}

\ExecuteOptions{pointsubsection}

\ProcessOptions\relax

\RequirePackage{xecyr}
\RequirePackage{xstring}
\RequirePackage{gost8.009}
\RequirePackage{afterpage}
\RequirePackage{pdflscape}

\newdimen\logbook@subparams@margin
\logbook@subparams@margin=10mm

\newif\ifРЭ                   % указано руководство по эксплуатации 
\newif\ifНабор                % описываемое изделие является набором

\AtBeginDocument{%
	\Формуляр\Изделие\Документация\ifexists\РЭ{\РЭtrue}{\РЭfalse}%
	\Формуляр\Изделие\ifexists\Комплектующие{\Наборtrue}{\Наборfalse}%
}

\newcommand{\@Формуляр@ФамилияИО}[1]{%
	\@ФамилияИО{\Формуляр{#1}\ДолжностноеЛицо}%
}

\def\@ФамилияИО#1{%
	#1\Фамилия~#1\Инициалы%
}

\def\Документ#1{%
	#1\Наименование%
	#1\ifexists\Обозначение {%
		\space#1\Обозначение%
	}{}%
}


\AtBeginDocument{
	\ESKDcompany{\Формуляр\Организация\Наименование}
	\Формуляр\Организация\ifexists\Подразделение {
		\ESKDdepartment{\Формуляр\Организация\Подразделение}
	}{}
	\def\Изделие{\Формуляр\Изделие}
	\Изделие\ifexists\КодОКП {
		\ESKDclassCode{ОКП~\StrLeft{\Изделие\КодОКП}{2}~\StrGobbleLeft{\Изделие\КодОКП}{2}}
	}{}

	\ESKDtitle{\Изделие\Наименование}
	\ESKDdocName{Формуляр}
	\ESKDsignature{\Изделие\Обозначение}
	
	\ESKDtitleDesignedBy{Ведущий инженер по метрологии}{Богданова~Т.~М.}
	\ESKDtitleDesignedBy{Инженер по метрологии}{Дель~Н.~Н.}
	
	\ESKDtitleAgreedBy{\Формуляр\Согласовал[1]\ДолжностноеЛицо\Должность}{\@ФамилияИО{\Формуляр\Согласовал[1]\ДолжностноеЛицо}}
	\ESKDtitleAgreedBy{Инженер по стандартизации}{Наумова~Т.~И.}
	\ESKDtitleAgreedBy{Инженер по стандартизации}{Наумова~Т.~И.}
	
	\ESKDtitleApprovedBy{%
		\Формуляр\Утвердил\ДолжностноеЛицо\Должность%
	}{\@Формуляр@ФамилияИО{Утвердил}}

	\ESKDauthor{\@ФамилияИО{\Формуляр\Разработал[1]\ДолжностноеЛицо}}
	\ESKDchecker{\@Формуляр@ФамилияИО{Проверил}}
	\Формуляр\ifexists\МетрологическийКонтроль{
		\renewcommand{\ESKDcolumnXfIVname}{М.~контр.}
		\ESKDcolumnXIfIV{\@Формуляр@ФамилияИО{МетрологическийКонтроль}}
	}{}
	\ESKDnormContr{\@Формуляр@ФамилияИО{Нормоконтроль}}
	\ESKDapprovedBy{\@Формуляр@ФамилияИО{Утвердил}}
	
	%\ESKDdate{2014/10/24}
}

\LoadClass{gost2.105}
\RequirePackage{gost2.612}
\RequirePackage{todo}

\newcommand{\УказанияПоЭксплуатацииИзделия}[1]{
	\@namedef{Формуляр@УказанияПоЭксплуатацииИзделия}{#1}
}

\УказанияПоЭксплуатацииИзделия{
	\paragraph{} Перед эксплуатацией изделия следует внимательно изучить
	эксплуатационную документацию на изделие%
	\ifРЭ
		, в частности~--- \Документ{\Изделие\Документация\РЭ}%
		\done\todo{Необходима подстановка обозначения руководства и его наименования}%
		.
		\todo{Для оформления ссылок на сторонние документы необходимо определить свои
			макросы, которые обеспечат корректные пробелы и, возможно, другое оформление}
	\fi
}

\newcommand{\ПравилаЗаполненияИВеденияФормуляра}[1]{
	\@namedef{Формуляр@ПравилаЗаполненияИВеденияФормуляра}{#1}
}

\newcommand{\РесурсыСрокиСлужбыХраненияГарантииИзготовителя}[1]{
	\@namedef{Формуляр@РесурсыСрокиСлужбыХраненияГарантииИзготовителя}{#1}
}

\newcommand{\СвидетельствоОбУпаковывании}[1]{
	\@namedef{Формуляр@СвидетельствоОбУпаковывании}{#1}
}

\ПравилаЗаполненияИВеденияФормуляра{
	\paragraph{}\label{МОЛ} За ведение формуляра отвечает лицо, ответственное за эксплуатацию изделия.
	Ответственное за эксплуатацию изделия лицо указано в
	инвентарной карточке учёта объекта основных средств (форма №~ОС-6),
	хранящейся в регистрах бухгалтерского учёта.
	
	\paragraph{} Не допускаются записи в формуляре карандашом, смывающимися чернилами.
	Не допускаются подчистки.
	Неправильная запись должна быть аккуратно зачёркнута и рядом (в следующей строке) внесена новая запись.
	
	\paragraph{} Новые записи следует заверять подписью лица, ответственного за эксплуатацию изделия.
	После подписи следует указать фамилию и инициалы ответственного лица (вместо подписи допускается
	проставлять личный штамп).
	
	\paragraph{} При передаче изделия на другое предприятие итоговые записи по
	наработке следует заверять печатью предприятия, передающего изделие.
}

\newcommand{\ИндивидуальныеОсобенностиИзделия}[1]{
	\@namedef{Формуляр@ИндивидуальныеОсобенностиИзделия}{#1}
}

\AtBeginDocument{
	\maketitle
	\tableofcontents

	\ifx\Формуляр@УказанияПоЭксплуатацииИзделия\empty\else
		\ifx\Формуляр@ПравилаЗаполненияИВеденияФормуляра\empty\else
			
			\section{Общие указания}
			
			\ifx\Формуляр@УказанияПоЭксплуатацииИзделия\empty\else
				\subsection{Указания по эксплуатации изделия}
				\Формуляр@УказанияПоЭксплуатацииИзделия
			\fi
			
			\ifx\Формуляр@ПравилаЗаполненияИВеденияФормуляра\empty\else
				\subsection{Правила заполнения и ведения формуляра}
				\Формуляр@ПравилаЗаполненияИВеденияФормуляра
			\fi
			
		\fi
	\fi
	
	
	\section{Основные сведения об изделии}
	
	\paragraph{Наименование изделия}: \Изделие\Наименование.
	\done\todo{Заменить на свой макрос}
	
	\paragraph{Дата изготовления}: \Изделие\ДатаИзготовления.
	\done\todo{Указать дату изготовления, форматировать макросом}
	\todo{Форматировать даты макросами}
	
	\paragraph{Производитель}:
	\def\Производитель{\Изделие\Производитель}%
	\Производитель\ifexists\АдресСайта {%
		\href{\Производитель\АдресСайта}{\Производитель\Наименование}%
	}{%
		\Производитель\Наименование%
	}.
	\done\todo{Указать производителя}
	\done\todo{Дать ссылку на сайт производителя, если он указан}
	
	\paragraph{Заводской номер}: \Изделие\Номер.
	\done\todo{Указать заводской номер}

	\Изделие\ifexists\СредствоИзмерения {
		\def\СИ{\Изделие\СредствоИзмерения}

		\paragraph{Тип средства измерения}: \СИ\ТипСИ.
		\done\todo{Указать тип средства измерения, если он указан в реквизитах}
		
		\paragraph{Регистрационный номер в Государственном реестре средств измерений}:
		\href{http://www.fundmetrology.ru/10\_tipy\_si/7list.aspx?z=\&n=\СИ\НомерГРСИ}{\СИ\НомерГРСИ}.
		\done\todo{Указать номер в ГРСИ, если он указан}
		\done\todo{Дать гиперссылку на сайт ФИФ на номере ГРСИ, либо вообще - на всём параграфе}
		\todo{Для ссылок на ФИФ целесообразно определить свой макрос в отдельном стилевом файле}
		\todo{Ввести сокращения СИ, ГРСИ, расшифровах их в соответствующем разделе}
		
		\СИ\ifexists\СвидетельствоОРегистрацииТипаСИ {
			\def\Свидетельство{\СИ\СвидетельствоОРегистрацииТипаСИ}
		
			\paragraph{Номер свидетельства о регистрации типа средства измерения}: \Свидетельство\Номер.
			\done\todo{Указать номер свидетельства, если он указан}
			
			\paragraph{Срок действия свидетельства о регистрации типа средства измерения}:
			\Свидетельство\ifexists\СрокДействия%
				{\Свидетельство\СрокДействия}%
				{не указан}%
			.
			\done\todo{Указать срок действия свидетельства, если он указан}
			\todo{Форматировать даты макросами}
	
		}{}

	}{}
		
	
	\section{Основные технические данные}
	
	\Изделие\ifexists\КаналыИзмерений {
		Метрологические характеристики%
		\footnote{Обозначения физических величин приведены в соответствии с МИ~2246-93.
			\todo{Обозначение МИ - в макрос для библиографии}
			\todo{Проверить оформление сносок по ГОСТ~2.105}
		}%
		\footnote{Обозначения нормируемых метрологических характеристик приведены в соответствии с ГОСТ~8.009.
			\todo{Обозначение ГОСТ - в макрос для библиографии}
		}
				приведены в таблице~\ref{МетрологическиеХарактеристики}.
		\done\todo{Заполнить раздел <<Основные технические сведения>> сведениями об измерительных каналах и
			нормируемых метрологических характеристиках}
	}{}
	
	\Изделие\ifexists\Характеристики {
		Основные технические данные приведены в таблице~\ref{Характеристики}.
		\done\todo{Заполнить раздел <<Основные технические сведения>> характеристиками}
	}{}

	\newif\ifОтИДоВОднихЕИ

	\afterpage{
		\begin{landscape}
			\Изделие\ifexists\КаналыИзмерений {
				\begin{gost2.105.table}
					{Метрологические характеристики}{МетрологическиеХарактеристики}
					{X[b]|X[-1,c]|X[-1,r,b]}
					{Наименование параметра & Диапазон & Значение}
					\resettabledata
					\Изделие\КаналыИзмерений\foreach{\КаналИзмерений}{
						\edef\ЕдиницаИзмерения{\КаналИзмерений\Диапазон\От\ЕдиницаИзмерения}
						\edef\reserved@b{\КаналИзмерений\Диапазон\До\ЕдиницаИзмерения}
						\ifx\ЕдиницаИзмерения\reserved@b \ОтИДоВОднихЕИtrue \else \ОтИДоВОднихЕИfalse \fi
						%
						\eaddtabledata{\КаналИзмерений\Наименование}
						\КаналИзмерений\ifexists\Обозначение{\eaddtabledata{ $\КаналИзмерений\Обозначение$}}{}%
						\ifОтИДоВОднихЕИ\eaddtabledata{, \ЕдиницаИзмерения}\fi
						\addtabledata{&}
						\eaddtabledata{От~}
							\addtabledata{$\numprint}
								\eaddtabledata{{\КаналИзмерений\Диапазон\От\Значение}}
								\addtabledata{$}
							\ifОтИДоВОднихЕИ\else \eaddtabledata{~\КаналИзмерений\Диапазон\От\ЕдиницаИзмерения} \fi					
						\eaddtabledata{ до~}
							\addtabledata{$\numprint}
								\eaddtabledata{{\КаналИзмерений\Диапазон\До\Значение}}
								\addtabledata{$}
							\ifОтИДоВОднихЕИ\else \eaddtabledata{~\КаналИзмерений\Диапазон\До\ЕдиницаИзмерения} \fi					
						\eaddtabledata{~включ.}
						\addtabledata{&}
						%
						\КаналИзмерений\ifexists\НормируемыеМетрологическиеХарактеристики {
							\КаналИзмерений\НормируемыеМетрологическиеХарактеристики\foreach{\Характеристика}{
								\addtabledata{\\\nopagebreak}
								%
								\edef\ЕдиницаИзмерения{\КаналИзмерений\Диапазон\От\ЕдиницаИзмерения}
								\edef\reserved@b{\КаналИзмерений\Диапазон\До\ЕдиницаИзмерения}
								\ifx\ЕдиницаИзмерения\reserved@b \ОтИДоВОднихЕИtrue \else \ОтИДоВОднихЕИfalse \fi
								%
								\def\ЕдиницаИзмерения{\Характеристика\Значение\ЕдиницаИзмерения}
								\КаналИзмерений\ifexists\Обозначение{
									\def\Обозначение{%
										\AccuracyNormSymbol{\Характеристика\МетрологическаяХарактеристика}(\КаналИзмерений\Обозначение)%
									}
								}{
									\def\Обозначение{%
										\AccuracyNormSymbol{\Характеристика\МетрологическаяХарактеристика}%
									}
								}
								\addtabledata{\hspace{\logbook@subparams@margin}\parbox[b]{\linewidth-\logbook@subparams@margin}}
									\eaddtabledata{{\Характеристика\Наименование%
										~\Обозначение%
										,~\ЕдиницаИзмерения}}
								\addtabledata{&}
								\Характеристика\ifexists\ВДиапазонеИзмерений {
									%
									\ОтИДоВОднихЕИfalse
									\def\reserved@b{\Характеристика\ВДиапазонеИзмерений\От\ЕдиницаИзмерения}
									\ifx\ЕдиницаИзмерения\reserved@b
										\def\reserved@b{\Характеристика\ВДиапазонеИзмерений\До\ЕдиницаИзмерения}
										\ifx\ЕдиницаИзмерения\reserved@b
											\ОтИДоВОднихЕИtrue
										\fi			
									\fi
									%
									\edef\ЕдиницаИзмерения{\Характеристика\ВДиапазонеИзмерений\От\ЕдиницаИзмерения}
									\edef\reserved@b{\Характеристика\ВДиапазонеИзмерений\До\ЕдиницаИзмерения}
									\ifx\ЕдиницаИзмерения\reserved@b \ОтИДоВОднихЕИtrue \else \ОтИДоВОднихЕИfalse \fi
									%
									\eaddtabledata{От~}
										\addtabledata{$\numprint}
											\eaddtabledata{{\Характеристика\ВДиапазонеИзмерений\От\Значение}}
											\addtabledata{$}
										\ifОтИДоВОднихЕИ\else \eaddtabledata{~\Характеристика\ВДиапазонеИзмерений\От\ЕдиницаИзмерения} \fi					
									\eaddtabledata{ до~}
										\addtabledata{$\numprint}
											\eaddtabledata{{\Характеристика\ВДиапазонеИзмерений\До\Значение}}
											\addtabledata{$}
										\ifОтИДоВОднихЕИ\else \eaddtabledata{~\Характеристика\ВДиапазонеИзмерений\До\ЕдиницаИзмерения} \fi					
									\eaddtabledata{~включ.}
								}{}
								\addtabledata{&}
								\addtabledata{$\numprint}
									\eaddtabledata{{\Характеристика\Значение\Значение}}
									\addtabledata{$}
							}
						}{}%
						%
						\addtabledata{\\}
						\addtabledata{\hline}
					}%
					\flushtabledata
				\end{gost2.105.table}
				\done\todo{При выводе единиц измерения диапазона при условии, что ЕИ начала и
					конца диапазона совпадает выводить её один раз, непосредственно за
					наименованием канала}
				\todo{Если ЕИ всех каналов, диапазонов и МХ совпадают - указать ЕИ для таблицы в целом}
				\todo{Если ЕИ всех каналов и МХ совпадают - указать ЕИ для столбца Значение}
				\todo{группировать МХ и объединять диапазоны (от, свыше и т.д.)}
			}{}
			\Изделие\ifexists\Характеристики {
				\begin{gost2.105.table}
					{Основные технические данные}{Характеристики}
					{X[b]|X[-1,r,b]}
					{ Наименование параметра & Значение }
					\resettabledata
					\Изделие\Характеристики\foreach{\Характеристика}{
						\eaddtabledata{\Характеристика\Наименование, \Характеристика\Значение\ЕдиницаИзмерения}
						\addtabledata{&}
						\addtabledata{$\numprint}
							\eaddtabledata{{\Характеристика\Значение\Значение}}
							\addtabledata{$}
						\addtabledata{\\} %\hline}
					}%
					\flushtabledata
				\end{gost2.105.table}
				\todo{Если ЕИ всех характеристик совпадают - указать ЕИ для таблицы}
			}{}
		\end{landscape}
	}
		
	\ifРЭ
		Более подробно~--- смотрите \Документ{\Изделие\Документация\РЭ}.
		\done\todo{Указать обозначение руководства по эксплуатации}
		\done\todo{Абзац вставлять только в том случае, если руководство по эксплуатации указано}
	\fi

	\@ifundefined{Формуляр@ИндивидуальныеОсобенностиИзделия}{}{
	\section{Индивидуальные особенности изделия}

	\@nameuse{Формуляр@ИндивидуальныеОсобенностиИзделия}
	\done\todo{Раздел <<Индивидуальные особенности изделия>> приводить только в том случае, если таковые
		указаны в данных}
	
	}
	
	\ifНабор
	\section{Комплектность}
	
	\todo{Сформировать раздел <<Комплектность>>}
	\done\todo{Раздел <<Комплектность>>  приводить только в том случае, если данные о комплектности
		присутствуют в данных}
	\fi
	
	
	\@ifundefined{Формуляр@РесурсыСрокиСлужбыХраненияГарантииИзготовителя}{}{
	\section{Ресурсы, сроки службы и хранения, гарантии изготовителя}
	
	\done\todo{Раздел <<Ресурсы, сроки службы и хранения, гарантии изготовителя>>
		приводить только в том случае, если данные присутствуют}
	}
	
	
	\section{Консервация}
	
	\todo{Заполнить раздел <<Консервация>>}
	
	
	\@ifundefined{Формуляр@СвидетельствоОбУпаковывании}{}{
	\section{Свидетельство об упаковывании}
	
	\done\todo{Раздел <<Свидетельство об упаковывании>>
		приводить только в том случае, если данные присутствуют}
	}
	
	Данные об упаковывании изделия приведены в руководстве по эксплуатации.
	\todo{Абзац вставлять только в том случае, если руководство по эксплуатации указано}
	\todo{Указать обозначение руководства по эксплуатации}
	
	
	\section{Свидетельство о приёмке}
	
	\todo{Раздел <<Свидетельство о приёмке>>
		приводить только в том случае, если данные присутствуют}
	
	Данные о приёмке изделия приведены в руководстве по эксплуатации.
	\todo{Абзац вставлять только в том случае, если руководство по эксплуатации указано}
	\todo{Указать обозначение руководства по эксплуатации}
	
	
	\section{Движение изделия при эксплуатации}
	
	\todo{Заполнить раздел <<Движение изделия при эксплуатации>>}
	
	\subsection{Приём и передача изделия}
	
	\todo{Заполнить раздел <<Приём и передача изделия>>}
	
	\subsection{Сведения о закреплении изделия при эксплуатации}
	
	\todo{Заполнить раздел <<Сведения о закреплении изделия при эксплуатации>>}
	
	
	%\section{Учёт работы изделия}
	
	
	\section{Учёт технического обслуживания}
	
	\todo{Заполнить раздел <<Учёт технического обслуживания>>}
	
	
	%\section{Учёт работы по бюллетням и указаниям}
	
	
	\section{Работы при эксплуатации}
	
	\todo{Заполнить раздел <<Работы при эксплуатации>>}
	
	\subsection{Учёт выполнения работ}
	
	\todo{Заполнить раздел <<Учёт выполнения работ>>}
	
	\subsection{Особые замечания по эксплуатации и аварийным случаям}
	
	\todo{Заполнить раздел <<Особые замечания по эксплуатации и аварийным случаям>>}
	
	\subsection{Поверка средств измерений}
	
	\todo{Заполнить раздел <<Поверка средств измерений>>}
	
	\subsection{Техническое освидетельствование контрольными органами}
	
	\todo{Заполнить раздел <<Техническое освидетельствование контрольными органами>>,
		если он требуется для изделия}
	
	\subsection{Сведения о рекламациях}
	
	\todo{Заполнить раздел <<Сведения о рекламациях>>}
	
	
	\section{Хранение}
	
	\todo{Заполнить раздел <<Хранение>>}
	
	
	\section{Ремонт}
	
	\todo{Заполнить раздел <<Ремонт>>}
	
	\subsection{Краткие сведения о произведённом ремонте}
	
	\todo{Заполнить раздел <<Краткие сведения о произведённом ремонте>>}
	
	\subsection{Данные приёмосдаточных испытаний}
	
	\todo{Заполнить раздел <<Краткие сведения о произведённом ремонте>>}
	
	\subsection{Свидетельство о приёмке и гарантии}
	
	\todo{Заполнить раздел <<Свидетельство о приёмке и гарантии>>}
	
	
	\section{Особые отметки}
	
	\todo{Вставить чистые графы для раздела <<Особые отметки>> для ручного заполнения}
	\todo{В дальнейшем заполнять раздел <<Особые отметки>>}
	
	
	\section{Сведения об утилизации}
	
	Сведения об утилизации изделия приведены в руководстве по эксплуатации.
	\todo{Указать обозначение руководства по эксплуатации}
	
	
	\section{Контроль состояния изделия и ведения формуляра}
	
	\todo{Заполнить раздел <<Контроль состояния изделия и ведения формуляра>>}
	
	
	\section{Сведения о цене и условиях приобретения изделия}
	
	\todo{Заполнить раздел <<Сведения о цене и условиях приобретения изделия>>}

	\clearpage
}

\AtEndDocument{
	\newpage
	\todo{Создать и заполнить раздел терминов и определений}
	\todo{Создать и заполнить раздел списка литературы}
	\newpage
	
	\todos{}
}
