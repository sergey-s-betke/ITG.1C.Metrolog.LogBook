\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost6.38}[2014/10/22 v0.1 ГОСТ 6.38-90 ОРД. Требования к оформлению документов]

\ProcessOptions\relax

\RequirePackage{xparse}

\newcommand*{\signatureStampTitle}[1]{%
	\centering%
	\textbf{
		\MakeUppercase{#1}
	}
	\par
	\vspace{2ex minus 0.5ex}
}

% собственно гриф документа
\newcommand{\signatureStamp@Title}[1]{%
	\par{\signatureStampTitle{#1}\par}
}

\newcommand*{\signatureStampPost}[1]{#1}

% должность в грифе документа
\newcommand{\signatureStamp@Post}[1]{%
	\par{\signatureStampPost{#1}\par}
}

% графа с пояснением
\newcommand{\annotatedField}[3]{%
	{%
		\parbox[t]{#1}{%
			\centering#2\\%
			\renewcommand{\baselinestretch}{1}\selectfont%
			\vspace{-0.2ex}%
			\tiny#3%
		}%
	}
}

\newlength\@annotatedFieldWidth@t
\newlength\@annotatedFieldWidth

% ФИО и подпись в грифе документа
\newcommand{\annotatedFieldLine}[3]{%
	{%
		\par%
		\settowidth{\@annotatedFieldWidth@t}{ #2}%
		\setlength{\@annotatedFieldWidth}{\linewidth}%
		\addtolength{\@annotatedFieldWidth}{-\@annotatedFieldWidth@t}%
		\annotatedField{\@annotatedFieldWidth}{#1}{#3}%
		\hfill#2%
		\par%
	}
}

\newcommand*{\signatureStampName}[1]{#1}

% ФИО и подпись в грифе документа
\newcommand{\signatureStamp@NameAndSignature}[1]{%
	\annotatedFieldLine%
		{\hrulefill}%
		{{\signatureStampName{#1}}}%
		{подпись}%
}

% Шаблон даты
\newcommand{\dateTemplate}[0]{%
	<<\vbox{\hbox{\hspace{0em plus 1em}\phantom{99}\strut\hspace{0em plus 1em}}\hrule height .4pt}>>~%
	\vbox{\hbox{\hspace{0em plus 2em}\phantom{сентября}\strut\hspace{0em plus 2em}}\hrule height .4pt}~%
	\vbox{\hbox{\hspace{0em plus 1em}\phantom{2999}\strut\hspace{0em plus 1em}}\hrule height .4pt}%
}

\newlength\@dateTemplateWidth
		
% Дата подписи в грифе документа
\newcommand{\signatureStamp@Date}[1]{%
	\settowidth{\@dateTemplateWidth}{\dateTemplate}%
	\annotatedField{\@dateTemplateWidth}{\dateTemplate}{дата}%
}

% гриф документа по п.1.4
% * - растянуть дату на всю ширину подписи
% #2 - собственно гриф (Утверждаю, Согласовано и т.д.)
% #3 - должность 
% #4 - ФИО
% #5 - дата
\NewDocumentCommand{\signatureStamp}{s o m m m}{%
	\IfNoValueTF{#2}{}{%
		\signatureStamp@Title{#2}%
	}
	\signatureStamp@Post{#3}%
	\signatureStamp@NameAndSignature{#4}%
	\IfBooleanTF{#1}{%
		\signatureStamp@Date{#5}%
	}{%
		{%
			\centering%
			\signatureStamp@Date{#5}%
		}
	}%
	\vspace{2ex plus 1ex minus 1ex}
}

\newlength\@signatureStampBoxW
\setlength{\@signatureStampBoxW}{20em}

\NewDocumentCommand{\signatureStampBox}{s o m m m}{%
	\IfBooleanTF{#1}{%
		\signatureStamp*[#2]{#3}{#4}{#5}%
	}{%
		\parbox[t]{\@signatureStampBoxW}{\signatureStamp[#2]{#3}{#4}{#5}}%
	}%
}
\let\signatureStampVisaBox\signatureStampBox
