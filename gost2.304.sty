\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost2.304}[2014/12/20 v0.2 ГОСТ 2.304-81 ЕСКД. Шрифты чертежные]
% используем шрифты A и Б, последний - для "утолщённых" начертаний

\RequirePackage{expl3}
\RequirePackage{l3keys2e}
\RequirePackage{ifxetex}
\RequireXeTeX

\ExplSyntaxOn

% ряд размеров шрифтов h по ГОСТ 2.304
% применяемые размеры шрифта h=2,5; 3,5; 5,0; 7,0; 10,0; 14,0; 20,0; 28,0; 40,0 мм
% п.3.3 ГОСТ 2.105-95 - высота шрифта не менее 2,5 мм
% ввожу в ряд 1.8mm только ради формул (индексов, прочего)
\clist_new:N \c__eskdfont_fontsizes_clist
\clist_gset:Nn \c__eskdfont_fontsizes_clist {1.8mm, 2.5mm, 3.5mm, 5mm, 7mm, 10mm, 14mm, 20mm, 28mm, 40mm}

%\newcount\@gostfont@normalsize@number
%\define@choicekey{\@currname.\@currext}{mainfontsize}
%	[ \@mainfontsize \@normalsize@number ]
%	{ 2.5mm, 3.5mm, 5mm, 7mm, 10mm, 14mm, 20mm }
%{%
%	\@gostfont@normalsize@number=\@normalsize@number\relax
%	\advance \@gostfont@normalsize@number by 2\relax
%}
\keys_define:nn { gost2.304 }
{
  mainfontsize .code:n =
  {
    \__eskdfont_normalsize_set:n {#1}
  }
}

\msg_new:nnn {gost2.304} {unexpected-font-size}
  {
    The~ font~ size~ "#1"~ unexprected.
    Valid~ eskd~ font~ sizes:~ \clist_use:Nn \c__eskdfont_fontsizes_clist {,~ }.
  }

\dim_new:N \l__eskdfont_mainfontsize_dim
\bool_new:N \l__eskdfont_mainfontsize_bool

\cs_new:Npn \__eskdfont_normalsize_set:n #1 {
  \dim_set:Nn \l_tmpa_dim {#1}
  \bool_set_false:N \l__eskdfont_mainfontsize_bool
  \clist_map_inline:Nn \c__eskdfont_fontsizes_clist
    {
      \dim_compare:nNnT \l_tmpa_dim = {##1}
        {
          \bool_set_true:N \l__eskdfont_mainfontsize_bool
          \clist_map_break:
        }
    }
  \bool_if:NTF \l__eskdfont_mainfontsize_bool
    {
    }
    {
      \msg_fatal:nnn {gost2.304} {unexpected-font-size} {#1}
    }
}

\PassOptionsToPackage{T2A}{fontenc}
\PassOptionsToPackage{T1}{fontenc}

\ProcessKeysOptions { gost2.304 }

\RequirePackage{cmap}
\RequirePackage{fontenc}
\RequirePackage{xecyr}
\RequirePackage{xparse}
\RequirePackage{fontspec}

\cs_new_nopar:Npn \__eskdfont_fontsizeget:n #1
  {
    \clist_item:Nn \c__eskdfont_fontsizes_clist #1
  }
\cs_generate_variant:Nn \__eskdfont_fontsizeget:n { N }
\cs_generate_variant:Nn \__eskdfont_fontsizeget:n { x }
\cs_generate_variant:Nn \__eskdfont_fontsizeget:n { V }

\newcommand\@gostfont@fontsize@map[1]{%
	\__eskdfont_fontsizeget:n#1%
}

\ExplSyntaxOff

\def\@gostfont@setupsizes{%
	\newcount\@gostfont@small@number
	\newcount\@gostfont@footnotesize@number
	\newcount\@gostfont@scriptsize@number
	\newcount\@gostfont@tiny@number
	\newcount\@gostfont@large@number
	\newcount\@gostfont@Large@number
	\newcount\@gostfont@LARGE@number
	\newcount\@gostfont@huge@number
	\newcount\@gostfont@Huge@number
	%
	\ifcase \@gostfont@normalsize@number
		% 1,8mm
	\or
		% 2,5mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		%\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -1\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 3,5mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -1\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 5,0mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -1\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 7,0mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 10mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		%\advance \@gostfont@Huge@number by 1\relax
	\or
		% 14mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		%\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		%\advance \@gostfont@Huge@number by 1\relax
	\or
		% 20mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		%\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		%\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		%\advance \@gostfont@Huge@number by 1\relax
	%\or
		% 28mm
	%\or
		% 40mm
	\fi
	%
	\def\normalsize{%
		\@gostfont@fontsize[\normalsize]{\@gostfont@fontsize@map\@gostfont@normalsize@number}%
		\selectfont
	}
	\def\small{%
		\@gostfont@fontsize[\small]{\@gostfont@fontsize@map\@gostfont@small@number}%
		\selectfont
	}
	\def\footnotesize{%
		\@gostfont@fontsize[\footnotesize]{\@gostfont@fontsize@map\@gostfont@footnotesize@number}%
		\selectfont
	}
	\def\scriptsize{%
		\@gostfont@fontsize[\scriptsize]{\@gostfont@fontsize@map\@gostfont@scriptsize@number}%
		\selectfont
	}
	\def\tiny{%
		\@gostfont@fontsize[\tiny]{\@gostfont@fontsize@map\@gostfont@tiny@number}%
		\selectfont
	}
	\def\large{%
		\@gostfont@fontsize[\large]{\@gostfont@fontsize@map\@gostfont@large@number}%
		\selectfont
	}
	\def\Large{%
		\@gostfont@fontsize[\Large]{\@gostfont@fontsize@map\@gostfont@Large@number}%
		\selectfont
	}
	\def\LARGE{%
		\@gostfont@fontsize[\LARGE]{\@gostfont@fontsize@map\@gostfont@LARGE@number}%
		\selectfont
	}
	\def\huge{%
		\@gostfont@fontsize[\huge]{\@gostfont@fontsize@map\@gostfont@huge@number}%
		\selectfont
	}
	\def\Huge{%
		\@gostfont@fontsize[\Huge]{\@gostfont@fontsize@map\@gostfont@Huge@number}%
		\selectfont
	}
}
\@onlypreamble\@gostfont@setupsizes

\def\@gostfont@name{Mipgost} %{ГОСТ 2.304-81}

\ExplSyntaxOn

\cs_generate_variant:Nn \dim_set:Nn { NV }
\cs_generate_variant:Nn \dim_to_fp:n { N }

{
	% определение действительного масштаба для шрифтов
	\def\@gostfont@features@#1#2{
		Path = fonts/,
		Extension = .ttf,
		UprightFont = *,
		OpticalSize = 0,
		Mapping = tex-text,
		Scale = #1,
		#2,
		BoldFont = *,
		BoldFeatures = {
			FakeBold = 1.4,
			OpticalSize = 0,
			#2
		},
		SlantedFont = *,
		SlantedFeatures = {
			FakeSlant = 0.258819, % cos(75 градусов)
			OpticalSize = 0,
			#2
		},
		BoldSlantedFont = *,
		BoldSlantedFeatures = {
			FakeBold = 1.4,
			FakeSlant = 0.258819,
			OpticalSize = 0,
			#2
		},
		%Kerning = On % not avaliable for ttf fonts
	}
	%
	\clist_new:N \l__eskdfont_fontsizes_clist
	\clist_set_eq:NN \l__eskdfont_fontsizes_clist \c__eskdfont_fontsizes_clist
	\tl_new:N \l__eskdfont_fontsizes_tl
	\tl_new:N \l__eskdfont_fonttinysize_tl
	\clist_pop:NN \l__eskdfont_fontsizes_clist \l__eskdfont_fonttinysize_tl
	% переводим 1.8mm в число в pt
	\dim_new:N \l__eskdfont_fonttinysize_dim
	\dim_set:NV \l__eskdfont_fonttinysize_dim \l__eskdfont_fonttinysize_tl
	\tl_set:Nx \l__eskdfont_fonttinysize_tl {\fp_eval:n {\dim_to_fp:N \l__eskdfont_fonttinysize_dim }}%
	% готовим список остальных допустимых размеров
	\tl_new:N \l__eskdfont_fontsize_mm_tl
	\clist_map_inline:Nn \l__eskdfont_fontsizes_clist{
		\tl_set:Nx \l__eskdfont_fontsize_mm_tl {\fp_eval:n {\dim_to_fp:n { #1 }}}%
		\tl_put_right:Nx \l__eskdfont_fontsizes_tl { { Size=\tl_use:N \l__eskdfont_fontsize_mm_tl }, }%
	}
	%
	\edef\@gostfont@sizefeatures@{
		SizeFeatures={
			{
				Size={\tl_use:N \l__eskdfont_fonttinysize_tl}, % п.2.2 ГОСТ 2.304-81
				Font=*, % как для шрифта типа Б
				FakeBold = 1.4
			},
			\tl_use:N \l__eskdfont_fontsizes_tl
		}
	}
	%
	\def\normalsize{%
		\fontsize{14mm}{22mm}\selectfont
	}
	%
	\@tempdima=100pt\relax
	\fontspec\@gostfont@name[\@gostfont@features@1{}]%
	\fontsize{\@tempdima}{\@tempdima}\selectfont
	\settoheight\@tempdimc{H}%

	\tl_new:N \l__eskdfont_fontscale_tl
	\tl_set:Nx \l__eskdfont_fontscale_tl {
		\fp_eval:n {
			\dim_to_fp:n { \@tempdima } /
			\dim_to_fp:n { \@tempdimc }
		}
	}
	\xdef\@gostfont@features{\@gostfont@features@\l__eskdfont_fontscale_tl\@gostfont@sizefeatures@}

	\fontspec\@gostfont@name[\@gostfont@features]
}
\ExplSyntaxOff

\newfontfamily\gostfont\@gostfont@name[\@gostfont@features]

\NewDocumentCommand\@gostfont@fontsize{o m o}{%
	\IfNoValueTF{#3}{%
		% расстояние между строками b = 22/14*h
		\@tempdimc=#2\relax
		\multiply \@tempdimc by 22\relax
		\divide \@tempdimc by 14\relax
		% расстояние между строками b = 17/10*h
		%\multiply \@tempdimc by 17\relax
		%\divide \@tempdimc by 10\relax
	}{%
		\@tempdimc=#3\relax
	}%
	\IfNoValueTF{#1}{%
		\fontsize{#2}{\@tempdimc}%
	}{%
		\@setfontsize{#1}{#2}{\@tempdimc}%
	}%
}

\AtBeginDocument{
%	\key@ifundefined{gost2.304.sty}{mainfontsize}{}{%
%		\@gostfont@setupsizes
%		\setmainfont\@gostfont@name[\@gostfont@features]%
%		\normalfont\normalsize
%	}
}
