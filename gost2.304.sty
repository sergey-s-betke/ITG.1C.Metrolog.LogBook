\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost2.304}[2014/12/20 v0.2 ГОСТ 2.304-81 ЕСКД. Шрифты чертежные]
% используем шрифты A и Б, последний - для "утолщённых" начертаний

\RequirePackage{expl3}
\RequirePackage{l3keys2e}

\ExplSyntaxOn

% NFSS идентификатор шрифта
\tl_const:Nn \c_eskdfont_tl {eskdfont}

% ряд размеров шрифтов h по ГОСТ 2.304
% применяемые размеры шрифта h=2,5; 3,5; 5,0; 7,0; 10,0; 14,0; 20,0; 28,0; 40,0 мм
% п.3.3 ГОСТ 2.105-95 - высота шрифта не менее 2,5 мм
% ввожу в ряд 1.8mm только ради формул (индексов, прочего)
\clist_new:N \c__eskdfont_fontsizes_clist
\clist_gset:Nn \c__eskdfont_fontsizes_clist {1.8mm, 2.5mm, 3.5mm, 5mm, 7mm, 10mm, 14mm, 20mm, 28mm, 40mm}

\bool_new:N \g__eskdfont_mainfontsize_bool
\bool_gset_false:N \g__eskdfont_mainfontsize_bool

\dim_new:N \g__eskdfont_normalsize_dim
\dim_new:N \g__eskdfont_small_dim
\dim_new:N \g__eskdfont_footnotesize_dim
\dim_new:N \g__eskdfont_scriptsize_dim
\dim_new:N \g__eskdfont_tiny_dim
\dim_new:N \g__eskdfont_large_dim
\dim_new:N \g__eskdfont_Large_dim
\dim_new:N \g__eskdfont_LARGE_dim
\dim_new:N \g__eskdfont_huge_dim
\dim_new:N \g__eskdfont_Huge_dim

\bool_new:N \g__eskdfont_romannumeral_check_bool
\bool_gset_false:N \g__eskdfont_romannumeral_check_bool

\cs_generate_variant:Nn \dim_to_decimal_in_unit:nn { cn }

\msg_new:nnn { gost2.304 } { mainfont }
  {
    Set~ eskdfont~ as~ main~ font.
  }
\msg_new:nnn { gost2.304 } { invalid-font-size }
  {
    The~ font~ size~ "#1"~ is~ invalid.~
    Valid~ eskd~ font~ sizes:~ \clist_use:Nn \c__eskdfont_fontsizes_clist {,~ }.
  }
\msg_new:nnn { gost2.304 } { invalid-mainfontsize }
  {
    Invalid~ "mainfontsize"~ value~ "#1".
  }
\msg_new:nnn { gost2.304 } { set-font-size }
  {
    Set~ "#1"~ font~ size~ to~ \dim_to_decimal_in_unit:cn {g__eskdfont_#1_dim} {1mm}~mm.
  }

\keys_define:nn { gost2.304 }
  {
    mainfontsize .code:n =
      {
        \clist_if_in:NnTF \c__eskdfont_fontsizes_clist {#1}
          {
            \dim_gset:Nn \g__eskdfont_normalsize_dim {#1}
            \bool_gset_true:N \g__eskdfont_mainfontsize_bool
          }
          { \msg_fatal:nnn { gost2.304 } {invalid-font-size} {#1} }
      },
    romannumeral .choice:,
    romannumeral / gost2.304 .code:n =
      { \bool_gset_true:N \g__eskdfont_romannumeral_check_bool },
    romannumeral / tex .code:n =
      { \bool_gset_false:N \g__eskdfont_romannumeral_check_bool },
    romannumeral .initial:n = { gost2.304 },
    quiet .code:n =
      {
        \msg_redirect_module:nnn { gost2.304 } { warning } { info }
        \msg_redirect_module:nnn { gost2.304 } { info } { none }
      },
    quiet .meta:n =
      {
        trace = off
      },
    silent .code:n =
      {
        \msg_redirect_module:nnn { gost2.304 } { warning } { none }
        \msg_redirect_module:nnn { gost2.304 } { info } { none }
      },
    silent .meta:n =
      {
        trace = off
      },
    warnings-off .code:n =
      {
        \clist_map_inline:nn {#1}
          { \msg_redirect_name:nnn { gost2.304 } { ##1 } { none } }
      },
    trace .choice:,
    trace / on .code:n = 
      {
        \msg_redirect_module:nnn { gost2.304 } { log } { log }
      },
    trace / debug .code:n =
      {
        \msg_redirect_module:nnn { gost2.304 } { log } { warning }
      },
    trace / off .code:n =
      {
        \msg_redirect_module:nnn { gost2.304 } { log } { none }
      }
  }

\ProcessKeysOptions { gost2.304 }

\PassOptionsToPackage{T2A}{fontenc}
\PassOptionsToPackage{T1}{fontenc}
\RequirePackage{fontenc}
\RequirePackage{cmap}
\RequirePackage{xecyr}
\RequirePackage{xparse}
\RequirePackage{fontspec}

\cs_new_nopar:Npn \__eskdfont_fontsizeget:n #1 {
  \clist_item:Nn \c__eskdfont_fontsizes_clist {#1}
}

\cs_new_nopar:Npn \__eskdfont_normalsize_gset:n #1
  {
    \dim_set:Nn \l_tmpa_dim {#1}
    \bool_gset_false:N \g__eskdfont_mainfontsize_bool
    \int_set_eq:NN \l_tmpa_int \c_zero
    \clist_map_inline:Nn \c__eskdfont_fontsizes_clist
      {
        \int_incr:N \l_tmpa_int
        \dim_compare:nNnT \l_tmpa_dim = {##1}
          {
            \bool_gset_true:N \g__eskdfont_mainfontsize_bool
            \clist_map_break:
          }
      }
    \bool_if:NTF \g__eskdfont_mainfontsize_bool
      {
        \int_case:nnTF { \l_tmpa_int }
          {
            { 2 } % 2,5mm
              {
                \dim_gset:Nn \g__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_small_dim    { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
                \dim_gset:Nn \g__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
                \dim_gset:Nn \g__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
                \dim_gset:Nn \g__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
              }
            { 3 } % 3,5mm
              {
                \dim_gset:Nn \g__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
                \dim_gset:Nn \g__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
                \dim_gset:Nn \g__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
                \dim_gset:Nn \g__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
              }
            { 4 } % 5,0mm
              {
                \dim_gset:Nn \g__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 3 } } }
                \dim_gset:Nn \g__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
                \dim_gset:Nn \g__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
                \dim_gset:Nn \g__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
                \dim_gset:Nn \g__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
              }
            { 5 } % 7,0mm
              {
                \dim_gset:Nn \g__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 3 } } }
                \dim_gset:Nn \g__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
                \dim_gset:Nn \g__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
                \dim_gset:Nn \g__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
                \dim_gset:Nn \g__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
              }
            { 6 } % 10mm
              {
                \dim_gset:Nn \g__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
                \dim_gset:Nn \g__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
                \dim_gset:Nn \g__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
                \dim_gset:Nn \g__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
              }
            { 7 } % 14mm
              {
                \dim_gset:Nn \g__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
                \dim_gset:Nn \g__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
                \dim_gset:Nn \g__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
                \dim_gset:Nn \g__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
                \dim_gset:Nn \g__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
                \dim_gset:Nn \g__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
                \dim_gset:Nn \g__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              }
          }
          {
            \clist_map_inline:nn {
              \normalsize, \small, \footnotesize, \scriptsize, \tiny,
              \large, \Large, \LARGE, \huge, \Huge
            }
              {
                \DeclareDocumentCommand ##1 {} {%
                  \__eskdfont_setfontsize_h:Nc ##1 {g__eskdfont_\cs_to_str:N ##1_dim}
                  \selectfont
                }
                \msg_log:nnx { gost2.304 } { set-font-size } {\cs_to_str:N ##1}
              }
            \setmainfont \c_eskdfont_tl
            \msg_log:nn { gost2.304 } { mainfont }
          }
          {
            \msg_fatal:nnn { gost2.304 } { invalid-mainfontsize } {#1}
          }
      }
      {
        \msg_fatal:nnn { gost2.304 } { invalid-font-size } {#1}
      }
  }
\@onlypreamble \__eskdfont_normalsize_gset:n
\cs_new_nopar:Nn \__eskdfont_normalsize_gset:
  {
    \__eskdfont_normalsize_gset:n \g__eskdfont_normalsize_dim
  }
\@onlypreamble \__eskdfont_normalsize_gset:

% основные параметры шрифтов ГОСТ 2.304
\tl_const:Nn \c__eskdfont_db_divide_da_tl { \fp_to_decimal:n { \fp_eval:n { 10 / 7 } } }
\defaultfontfeatures
  [eskdfont]
  {
    NFSSFamily = \c_eskdfont_tl,
    Path = fonts/,
    Extension = .ttf,
    UprightFont = Mipgost,
    OpticalSize = 0,
    Mapping = tex-text,
    Scale = 1,
    AutoFakeBold = \c__eskdfont_db_divide_da_tl,
    AutoFakeSlant = 0.258819, % cos(75 градусов)
    %Kerning = On, % not avaliable for ttf fonts
    %Numbers = Uppercase, % not avaliable in mipgost.ttf
  }

% определяем масштаб для шрифта
% 1ex = c, h = 14/10 c (или 10/7 c для шрифта типа Б)
% 1em = кегль шрифта (\f@size)
\group_begin:
  \fontspec \c_eskdfont_tl \fontsize { 100pt } { 100pt } \selectfont
  \tl_const:Nx \c__eskdfont_fontscale_tl
    { \dim_to_decimal:n { 1pt * \dim_ratio:nn { 10em } { 14ex } } }
\group_end:

\cs_new_nopar:Npn \__eskdfont_fontsize_from_h:NN #1#2
  {
    \dim_set:Nn #1 { \dim_eval:n { \c__eskdfont_fontscale_tl #2 } }
  }
\cs_new_nopar:Npn \__eskdfont_fontsize_from_h:Nn #1#2
  {
    \dim_set:Nn \l_tmpa_dim {#2}
    \__eskdfont_fontsize_from_h:NN #1 \l_tmpa_dim
  }

% ограничиваем допустимые размеры шрифтов
\clist_set_eq:NN \l_tmpa_clist \c__eskdfont_fontsizes_clist
\clist_pop:NN \l_tmpa_clist \l_tmpa_tl % tiny size
% переводим 1.8mm в число в pt
\dim_set:Nn \l_tmpa_dim \l_tmpa_tl
% готовим список остальных допустимых размеров
\seq_set_from_clist:NN \l_tmpa_seq \l_tmpa_clist
\seq_clear:N \l_tmpb_seq
\__eskdfont_fontsize_from_h:NN \l_tmpa_dim \l_tmpa_dim
\seq_push:Nx \l_tmpb_seq
  { {
    Size = \dim_to_decimal:n \l_tmpa_dim, % п.2.2 ГОСТ 2.304-81
    %Font = *, % как для шрифта типа Б
    FakeBold = \c__eskdfont_db_divide_da_tl
  } }
\seq_map_inline:Nn \l_tmpa_seq
  {
    \__eskdfont_fontsize_from_h:Nn \l_tmpa_dim {#1}
    \seq_push:Nx \l_tmpb_seq
      { { Size = \dim_to_decimal:n \l_tmpa_dim } }
  }

\defaultfontfeatures+
  [eskdfont]
  {
    SizeFeatures={ \seq_use:Nn \l_tmpb_seq {, } }
  }
\newfontfamily \eskdfont \c_eskdfont_tl

\cs_new_nopar:Npn \__eskdfont_b_from_h:n #1
  {
    \dim_eval:n { #1 * 22 / 14 }
  }

\cs_new_nopar:Npn \__eskdfont_setfontsize_h:Nnn #1#2#3
  {
    \__eskdfont_fontsize_from_h:Nn \l_tmpa_dim {#2}
    \@setfontsize{#1}{\l_tmpa_dim}{#3}%
    \ignorespaces
  }
\cs_new_nopar:Npn \__eskdfont_setfontsize_h:Nn #1#2
  {
    \__eskdfont_setfontsize_h:Nnn {#1}{#2}{ \__eskdfont_b_from_h:n {#2} }
  }
\cs_generate_variant:Nn \__eskdfont_setfontsize_h:Nn { Nc }

\cs_new_nopar:Npn \eskdfont_fontsize_h:nn #1#2
  {
    \__eskdfont_fontsize_from_h:Nn \l_tmpa_dim {#1}
    \fontsize{\l_tmpa_dim}{#2}%
    \ignorespaces
  }
\cs_new_nopar:Npn \eskdfont_fontsize_h:n #1
  {
    \eskdfont_fontsize_h:nn {#1}{ \__eskdfont_b_from_h:n {#1} }
  }

% в отличии от \fontsize устанавливает не кегль шрифта, а h (ex) параметр шрифта
\DeclareDocumentCommand \eskdfontsize {m o}
  {
    \IfNoValueTF{#2}
      { \eskdfont_fontsize_h:n {#1} }
      { \eskdfont_fontsize_h:nn {#1}{#2} }
    \ignorespaces
  }

% устанавливаем основной шрифт и производные размеры, если указана опция mainfontsize
\bool_if:NT \g__eskdfont_mainfontsize_bool
  { \__eskdfont_normalsize_gset: }

% опционально используем только заглавные римские цифры, как предусмотрено ГОСТ 2.304
\cs_new_nopar:Npn \eskdfont_int_to_Roman:n #1
  {
    \if_meaning:w \c_eskdfont_tl \f@family
      \__eskdfont_int_to_Roman_aux:n {#1}
    \else:
      \int_to_Roman:n {#1}
    \fi:
  }
\cs_new_nopar:Npn \eskdfont_int_to_roman:n #1
  {
    \if_meaning:w \c_eskdfont_tl \f@family
      \__eskdfont_int_to_Roman_aux:n {#1}
    \else:
      \int_to_roman:n {#1}
    \fi:
  }

\dim_new:N \l__eskdfont_romannumeral_kern_dim

\cs_generate_variant:Nn \tl_if_eq:nnTF {xx}
\cs_new_nopar:Npn \__eskdfont_int_to_Roman_aux:n #1
  {
    \group_begin:
      \tl_if_eq:xxTF \f@series {m}
        {
          % 1ex = c, h = 14/10 c, d = ex / 10, kern = -d
          \dim_set:Nn \l__eskdfont_romannumeral_kern_dim {-0.1ex}
        }
        {
          % 1ex = c, h = 10/7 c, d = ex / 7, kern = -3ex/49
          \dim_set:Nn \l__eskdfont_romannumeral_kern_dim {-0.0612245ex}
        }
      \cs_set_nopar:Npn \__int_to_Roman_i:w { I\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \cs_set_nopar:Npn \__int_to_Roman_v:w { V\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \cs_set_nopar:Npn \__int_to_Roman_x:w { X\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \cs_set_nopar:Npn \__int_to_Roman_l:w { L\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \cs_set_nopar:Npn \__int_to_Roman_c:w { C\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \cs_set_nopar:Npn \__int_to_Roman_d:w { D\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \cs_set_nopar:Npn \__int_to_Roman_m:w { M\tex_kern:D \l__eskdfont_romannumeral_kern_dim }
      \int_to_Roman:n {#1}
      \tex_kern:D -\l__eskdfont_romannumeral_kern_dim
    \group_end:
  }

\bool_if:NT \g__eskdfont_romannumeral_check_bool
  {
    \cs_set_eq:NN \@roman \eskdfont_int_to_roman:n
    \cs_set_eq:NN \@Roman \eskdfont_int_to_Roman:n
  }

\ExplSyntaxOff
