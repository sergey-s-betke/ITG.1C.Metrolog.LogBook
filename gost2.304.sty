\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost2.304}[2014/12/20 v0.2 ГОСТ 2.304-81 ЕСКД. Шрифты чертежные]
% используем шрифты A и Б, последний - для "утолщённых" начертаний

\RequirePackage{expl3}
\RequirePackage{l3keys2e}
\RequirePackage{ifxetex}
\RequireXeTeX

\ExplSyntaxOn

% ряд размеров шрифтов h по ГОСТ 2.304
% применяемые размеры шрифта h=2,5; 3,5; 5,0; 7,0; 10,0; 14,0; 20,0; 28,0; 40,0 мм
% п.3.3 ГОСТ 2.105-95 - высота шрифта не менее 2,5 мм
% ввожу в ряд 1.8mm только ради формул (индексов, прочего)
\clist_new:N \c__eskdfont_fontsizes_clist
\clist_gset:Nn \c__eskdfont_fontsizes_clist {1.8mm, 2.5mm, 3.5mm, 5mm, 7mm, 10mm, 14mm, 20mm, 28mm, 40mm}

\keys_define:nn { gost2.304 }
{
  mainfontsize .code:n =
  {
    \__eskdfont_normalsize_set:n {#1}
  }
}

\msg_new:nnn {gost2.304} {invalid-font-size}
  {
    The~ font~ size~ "#1"~ is~ invalid.~
    Valid~ eskd~ font~ sizes:~ \clist_use:Nn \c__eskdfont_fontsizes_clist {,~ }.
  }
\msg_new:nnn {gost2.304} {invalid-mainfontsize}
{
  Invalid~ "mainfontsize"~ value~ "#1".
}

\cs_new_nopar:Npn \__eskdfont_fontsizeget:n #1 {
  \clist_item:Nn \c__eskdfont_fontsizes_clist {#1}
}

\bool_new:N \l__eskdfont_mainfontsize_bool

\dim_new:N \l__eskdfont_normalsize_dim
\dim_new:N \l__eskdfont_small_dim
\dim_new:N \l__eskdfont_footnotesize_dim
\dim_new:N \l__eskdfont_scriptsize_dim
\dim_new:N \l__eskdfont_tiny_dim
\dim_new:N \l__eskdfont_large_dim
\dim_new:N \l__eskdfont_Large_dim
\dim_new:N \l__eskdfont_LARGE_dim
\dim_new:N \l__eskdfont_huge_dim
\dim_new:N \l__eskdfont_Huge_dim

\@onlypreamble \__eskdfont_normalsize_set:n
\cs_new_nopar:Npn \__eskdfont_normalsize_set:n #1 {
  \dim_set:Nn \l_tmpa_dim {#1}
  \bool_set_false:N \l__eskdfont_mainfontsize_bool
  \int_set_eq:NN \l_tmpa_int \c_zero
  \clist_map_inline:Nn \c__eskdfont_fontsizes_clist
    {
      \int_incr:N \l_tmpa_int
      \dim_compare:nNnT \l_tmpa_dim = {##1}
        {
          \bool_set_true:N \l__eskdfont_mainfontsize_bool
          \clist_map_break:
        }
    }
  \bool_if:NTF \l__eskdfont_mainfontsize_bool
    {
      \int_case:nnTF { \l_tmpa_int }
        {
          { 2 } % 2,5mm
            {
              \dim_set:Nn \l__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_small_dim    { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
              \dim_set:Nn \l__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
              \dim_set:Nn \l__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
              \dim_set:Nn \l__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
            }
          { 3 } % 3,5mm
            {
              \dim_set:Nn \l__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
              \dim_set:Nn \l__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
              \dim_set:Nn \l__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
              \dim_set:Nn \l__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
            }
          { 4 } % 5,0mm
            {
              \dim_set:Nn \l__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 3 } } }
              \dim_set:Nn \l__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
              \dim_set:Nn \l__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
              \dim_set:Nn \l__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
              \dim_set:Nn \l__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
            }
          { 5 } % 7,0mm
            {
              \dim_set:Nn \l__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 3 } } }
              \dim_set:Nn \l__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
              \dim_set:Nn \l__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
              \dim_set:Nn \l__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
              \dim_set:Nn \l__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 5 } } }
            }
          { 6 } % 10mm
            {
              \dim_set:Nn \l__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
              \dim_set:Nn \l__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
              \dim_set:Nn \l__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
              \dim_set:Nn \l__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 4 } } }
            }
          { 7 } % 14mm
            {
              \dim_set:Nn \l__eskdfont_tiny_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_scriptsize_dim   { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 2 } } }
              \dim_set:Nn \l__eskdfont_footnotesize_dim { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_small_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int - 1 } } }
              \dim_set:Nn \l__eskdfont_normalsize_dim   { \__eskdfont_fontsizeget:n \l_tmpa_int }
              \dim_set:Nn \l__eskdfont_large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 1 } } }
              \dim_set:Nn \l__eskdfont_Large_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 2 } } }
              \dim_set:Nn \l__eskdfont_LARGE_dim    { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
              \dim_set:Nn \l__eskdfont_Huge_dim     { \__eskdfont_fontsizeget:n { \int_eval:n { \l_tmpa_int + 3 } } }
            }
        }
        {
          \clist_map_inline:nn {
            \normalsize, \small, \footnotesize, \scriptsize, \tiny,
            \large, \Large, \LARGE, \huge, \Huge
          }
            {
              \DeclareDocumentCommand ##1 {} {%
                \__eskdfont_setfontsize:Nc ##1 {l__eskdfont_\cs_to_str:N ##1_dim}
                \selectfont
              }
            }
          \setmainfont \l__eskdfont_name [\@gostfont@features]
        }
        {
          \msg_fatal:nnn {gost2.304} {invalid-mainfontsize} {#1}
        }
    }
    {
      \msg_fatal:nnn {gost2.304} {invalid-font-size} {#1}
    }
}

\cs_new:Npn \__eskdfont_setfontsize:Nn #1#2 {%
  \@setfontsize{#1}{#2}{ \dim_eval:n { #2 * 22 / 14 } }%
}
\cs_generate_variant:Nn \__eskdfont_setfontsize:Nn { Nc }
\cs_new:Npn \__eskdfont_fontsize:n #1 {%
  \fontsize{#1}{ \dim_eval:n { #1 * 22 / 14 } }%
}

\PassOptionsToPackage{T2A}{fontenc}
\PassOptionsToPackage{T1}{fontenc}
\RequirePackage{fontenc}
\RequirePackage{cmap}
\RequirePackage{xecyr}
\RequirePackage{xparse}
\RequirePackage{fontspec}

\def \l__eskdfont_name {ГОСТ 2.304-81}
\def \l__eskdfont_filename {Mipgost}

% определение действительного масштаба для шрифтов
\def\@gostfont@features@#1#2{
  Path = fonts/,
  Extension = .ttf,
  UprightFont = \l__eskdfont_filename,
  OpticalSize = 0,
  Mapping = tex-text,
  Scale = #1,
  AutoFakeBold = 1.4,
  AutoFakeSlant = 0.258819, % cos(75 градусов)
  #2,
  %Kerning = On % not avaliable for ttf fonts
}

\clist_set_eq:NN \l_tmpa_clist \c__eskdfont_fontsizes_clist
\clist_pop:NN \l_tmpa_clist \l_tmpa_tl % tiny size
% переводим 1.8mm в число в pt
\dim_new:N \l__eskdfont_smallestsize_dim
\dim_set:Nn \l__eskdfont_smallestsize_dim \l_tmpa_tl
% готовим список остальных допустимых размеров
\seq_set_from_clist:NN \l_tmpa_seq \l_tmpa_clist
\seq_set_map:NNn \l_tmpa_seq \l_tmpa_seq { { Size={ \fp_eval:n { \dim_to_fp:n { #1 } } } } }

\edef\@gostfont@sizefeatures@{
  SizeFeatures={
    {
      Size={ \fp_eval:n { \dim_to_fp:n { \l__eskdfont_smallestsize_dim } } }, % п.2.2 ГОСТ 2.304-81
      Font=\l__eskdfont_filename, % как для шрифта типа Б
      FakeBold = 1.4
    },
    \seq_use:Nn \l_tmpa_seq {, }
  }
}

\dim_set:Nn \l_tmpa_dim { 40mm }
\hbox_set:Nn \l_tmpa_box
{%
  \fontspec \l__eskdfont_name [\@gostfont@features@1{}]%
  \fontsize{\l_tmpa_dim}{\l_tmpa_dim}\selectfont
  НШПС
}
\fp_new:N \l__eskdfont_fontscale_fp
\fp_set:Nn \l__eskdfont_fontscale_fp { \dim_to_fp:n \l_tmpa_dim / \dim_to_fp:n { \box_ht:N \l_tmpa_box } }

\xdef\@gostfont@features{\@gostfont@features@ { \fp_use:N \l__eskdfont_fontscale_fp } \@gostfont@sizefeatures@}

\newfontfamily \eskdfont \l__eskdfont_name [\@gostfont@features]

\ProcessKeysOptions { gost2.304 }

\DeclareDocumentCommand \eskdfontsize {m} {%
  \__eskdfont_fontsize:n {#1}%
}

\ExplSyntaxOff
