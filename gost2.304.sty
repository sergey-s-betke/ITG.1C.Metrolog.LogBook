\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gost2.304}[2014/12/20 v0.2 ГОСТ 2.304-81 ЕСКД. Шрифты чертежные]
% используем шрифты A и Б, последний - для "утолщённых" начертаний

\RequirePackage{expl3}
\RequirePackage{xkeyval}

\newcount\@gostfont@normalsize@number

\define@choicekey{\@currname.\@currext}{mainfontsize}
	[ \@mainfontsize \@normalsize@number ]
	{ 2.5mm, 3.5mm, 5mm, 7mm, 10mm, 14mm, 20mm }
{%
	\@gostfont@normalsize@number=\@normalsize@number\relax
	\advance \@gostfont@normalsize@number by 1\relax
}

\PassOptionsToPackage{T2A}{fontenc}
\PassOptionsToPackage{T1}{fontenc}

\ExecuteOptionsX{}

\ProcessOptionsX\relax


\RequirePackage{ifxetex}
\RequireXeTeX

\RequirePackage{cmap}
\RequirePackage{fontenc}
\RequirePackage{xecyr}
\RequirePackage{xparse}
\RequirePackage{fontspec}

% ряд размеров шрифтов h по ГОСТ 2.304
% применяемые размеры шрифта h=2,5; 3,5; 5,0; 7,0; 10,0; 14,0; 20,0; 28,0; 40,0 мм
% п.3.3 ГОСТ 2.105-95 - высота шрифта не менее 2,5 мм
% ввожу в ряд 1.8mm только ради формул (индексов, прочего)
\newcommand\@gostfont@fontsize@map[1]{%
	\ifcase #1 1,8mm\or 2,5mm\or 3,5mm\or 5,0mm\or 7,0mm\or 10mm\or 14mm\or 20mm\or 28mm\or 40mm\fi%
}

\def\@gostfont@setupsizes{%
	\newcount\@gostfont@small@number
	\newcount\@gostfont@footnotesize@number
	\newcount\@gostfont@scriptsize@number
	\newcount\@gostfont@tiny@number
	\newcount\@gostfont@large@number
	\newcount\@gostfont@Large@number
	\newcount\@gostfont@LARGE@number
	\newcount\@gostfont@huge@number
	\newcount\@gostfont@Huge@number
	%
	\ifcase \@gostfont@normalsize@number
		% 1,8mm
	\or
		% 2,5mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		%\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -1\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 3,5mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -1\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 5,0mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -1\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 7,0mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		\advance \@gostfont@Huge@number by 1\relax
	\or
		% 10mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		%\advance \@gostfont@Huge@number by 1\relax
	\or
		% 14mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		%\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		%\advance \@gostfont@Huge@number by 1\relax
	\or
		% 20mm
		\@gostfont@small@number=\@gostfont@normalsize@number
		\advance \@gostfont@small@number by -1\relax
		\@gostfont@footnotesize@number=\@gostfont@small@number
		\@gostfont@scriptsize@number=\@gostfont@small@number
		\advance \@gostfont@scriptsize@number by -1\relax
		\@gostfont@tiny@number=\@gostfont@small@number
		\advance \@gostfont@tiny@number by -2\relax
		\@gostfont@large@number=\@gostfont@normalsize@number
		\advance \@gostfont@large@number by 1\relax
		\@gostfont@Large@number=\@gostfont@large@number
		\advance \@gostfont@Large@number by 1\relax
		\@gostfont@LARGE@number=\@gostfont@Large@number
		%\advance \@gostfont@LARGE@number by 1\relax
		\@gostfont@huge@number=\@gostfont@LARGE@number
		%\advance \@gostfont@huge@number by 1\relax
		\@gostfont@Huge@number=\@gostfont@huge@number
		%\advance \@gostfont@Huge@number by 1\relax
	%\or
		% 28mm
	%\or
		% 40mm
	\fi
	%
	\def\normalsize{%
		\@gostfont@fontsize[\normalsize]{\@gostfont@fontsize@map\@gostfont@normalsize@number}%
		\selectfont
		%\abovedisplayskip 11\p@ \@plus3\p@ \@minus6\p@
		%\abovedisplayshortskip \z@ \@plus3\p@
		%\belowdisplayshortskip 6.5\p@ \@plus3.5\p@ \@minus3\p@
		%\belowdisplayskip \abovedisplayskip
		%\let\@listi\@listI
	}
	\def\small{%
		\@gostfont@fontsize[\small]{\@gostfont@fontsize@map\@gostfont@small@number}%
		\selectfont
		%\@setfontsize\small\@xpt\@xiipt
		%\abovedisplayskip 10\p@ \@plus2\p@ \@minus5\p@
		%\abovedisplayshortskip \z@ \@plus3\p@
		%\belowdisplayshortskip 6\p@ \@plus3\p@ \@minus3\p@
		%\def\@listi{%
		%	\leftmargin\leftmargini
		%	\topsep 6\p@ \@plus2\p@ \@minus2\p@
		%	\parsep 3\p@ \@plus2\p@ \@minus\p@
		%	\itemsep \parsep
		%}%
		%\belowdisplayskip \abovedisplayskip
	}
	\def\footnotesize{%
		\@gostfont@fontsize[\footnotesize]{\@gostfont@fontsize@map\@gostfont@footnotesize@number}%
		\selectfont
		%\@setfontsize\footnotesize\@ixpt{11}%
		%\abovedisplayskip 8\p@ \@plus2\p@ \@minus4\p@
		%\abovedisplayshortskip \z@ \@plus\p@
		%\belowdisplayshortskip 4\p@ \@plus2\p@ \@minus2\p@
		%\def\@listi{\leftmargin\leftmargini
		%	\topsep 4\p@ \@plus2\p@ \@minus2\p@
		%	\parsep 2\p@ \@plus\p@ \@minus\p@
		%	\itemsep \parsep}%
		%\belowdisplayskip \abovedisplayskip
	}
	\def\scriptsize{%
		\@gostfont@fontsize[\scriptsize]{\@gostfont@fontsize@map\@gostfont@scriptsize@number}%
		\selectfont
	}
	\def\tiny{%
		\@gostfont@fontsize[\tiny]{\@gostfont@fontsize@map\@gostfont@tiny@number}%
		\selectfont
	}
	\def\large{%
		\@gostfont@fontsize[\large]{\@gostfont@fontsize@map\@gostfont@large@number}%
		\selectfont
	}
	\def\Large{%
		\@gostfont@fontsize[\Large]{\@gostfont@fontsize@map\@gostfont@Large@number}%
		\selectfont
	}
	\def\LARGE{%
		\@gostfont@fontsize[\LARGE]{\@gostfont@fontsize@map\@gostfont@LARGE@number}%
		\selectfont
	}
	\def\huge{%
		\@gostfont@fontsize[\huge]{\@gostfont@fontsize@map\@gostfont@huge@number}%
		\selectfont
	}
	\def\Huge{%
		\@gostfont@fontsize[\Huge]{\@gostfont@fontsize@map\@gostfont@Huge@number}%
		\selectfont
	}
}
\@onlypreamble\@gostfont@setupsizes

\def\@gostfont@name{Mipgost} %{ГОСТ 2.304-81}

{
	% переводим 2.5mm в число в pt
	\ExplSyntaxOn
	\tl_gset:Nx \@gostfont@fontsize@first {\fp_eval:n {\dim_to_fp:n { 2.5mm }}}
	\ExplSyntaxOff
	% определение действительного масштаба для шрифтов
	\edef\@gostfont@features@#1{
		Path = fonts/,
		Extension = .ttf,
		UprightFont = *,
		OpticalSize = 0,
		Scale = #1,
		Mapping = tex-text,
		BoldFont = *,
		BoldFeatures = {
			FakeBold = 1.4,
			OpticalSize = 0
		},
		SlantedFont = *,
		SlantedFeatures = {
			FakeSlant = 0.258819, % cos(75 градусов)
			OpticalSize = 0
		},
		BoldSlantedFont = *,
		BoldSlantedFeatures = {
			FakeBold = 1.4,
			FakeSlant = 0.258819,
			OpticalSize = 0
		},
		SizeFeatures={
			{
				Size=-\@gostfont@fontsize@first, % п.2.2 ГОСТ 2.304-81
				Font=*, % как для шрифта типа Б
				FakeBold = 1.4
			},
			{ Size=\@gostfont@fontsize@first- }
		}
		%Kerning = On % not avaliable for ttf fonts
	}
	%
	\def\normalsize{%
		\fontsize{14mm}{22mm}\selectfont
	}
	%
	\@tempdima=100pt\relax
	\fontspec\@gostfont@name[\@gostfont@features@{1}]%
	\fontsize{\@tempdima}{\@tempdima}\selectfont
	\settoheight\@tempdimc{H}%
	\ExplSyntaxOn
	\tl_gset:Nx \l__fontspec_scale_tl {
		\fp_eval:n {
			\dim_to_fp:n { \@tempdima } /
			\dim_to_fp:n { \@tempdimc }
		}
	}
	\xdef\@gostfont@features{\@gostfont@features@{\l__fontspec_scale_tl}}
	\ExplSyntaxOff

	\fontspec\@gostfont@name[\@gostfont@features]
}

\newfontfamily\gostfont\@gostfont@name[\@gostfont@features]

\NewDocumentCommand\@gostfont@fontsize{o m o}{%
	\IfNoValueTF{#3}{%
		% расстояние между строками b = 22/14*h
		\@tempdimc=#2\relax
		\multiply \@tempdimc by 22\relax
		\divide \@tempdimc by 14\relax
		% расстояние между строками b = 17/10*h
		%\multiply \@tempdimc by 17\relax
		%\divide \@tempdimc by 10\relax
	}{%
		\@tempdimc=#3\relax
	}%
	\IfNoValueTF{#1}{%
		\fontsize{#2}{\@tempdimc}%
	}{%
		\@setfontsize{#1}{#2}{\@tempdimc}%
	}%
}

\AtBeginDocument{
	\key@ifundefined{gost2.304.sty}{mainfontsize}{}{%
		\@gostfont@setupsizes
		\setmainfont\@gostfont@name[\@gostfont@features]%
		\normalfont\normalsize
	}
}
